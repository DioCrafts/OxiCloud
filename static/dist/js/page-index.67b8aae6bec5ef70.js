let e=(()=>{"use strict";let e=0,t=0,i={};function o(){let t=document.getElementById("notif-bell-btn"),i=document.getElementById("notif-wrapper"),o=document.getElementById("notif-clear-btn");t&&(t.addEventListener("click",o=>{o.stopPropagation();let n=i.classList.toggle("open");t.classList.toggle("active",n);let r=document.getElementById("user-menu-wrapper");r&&r.classList.remove("open"),n&&(e=0,a());}),document.addEventListener("click",e=>{i.contains(e.target)||(i.classList.remove("open"),t.classList.remove("active"));}),o&&o.addEventListener("click",e=>{e.stopPropagation(),s();}));}function n(){e++,a(),function(){let e=document.getElementById("notif-bell-btn");e&&(e.classList.remove("ring"),e.offsetWidth,e.classList.add("ring"));}();}function a(){let t=document.getElementById("notif-badge");t&&(e>0?(t.style.display="",t.textContent=e>99?"99+":e):t.style.display="none");}function r(){let e=document.getElementById("notif-panel-body"),t=document.getElementById("notif-empty");if(!e||!t)return;let i=null!==e.querySelector(".notif-item");t.style.display=i?"none":"";}function l(e,t=""){let i=String(e||"").trim(),o=i.startsWith("fa-")?`fas ${i}`:i;return window.oxiIconFromFaClass(o,t);}function s(){let t=document.getElementById("notif-panel-body");t&&(t.querySelectorAll(".notif-item").forEach(e=>e.remove()),e=0,a(),r());}function d(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML;}function c(){let e=new Date,t=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0");return`${t}:${i}`;}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o(),{addUploadBatch:function(e,o){let n="batch-"+ ++t,a=document.getElementById("notif-panel-body");if(!a)return n;let s=document.createElement("div");s.className="notif-item",s.id=n;let u=window.i18n?.getCurrentLocale?.()||"en",m=o?u.startsWith("es")?`üìÅ Subiendo ${d(o)}‚Ä¶`:`üìÅ Uploading ${d(o)}‚Ä¶`:u.startsWith("es")?"Subiendo‚Ä¶":"Uploading‚Ä¶",w=u.startsWith("es")?"archivos":"files";s.innerHTML=`
            <div class="notif-item-icon upload">${l("fa-cloud-upload-alt")}</div>
            <div class="notif-item-body">
                <div class="notif-item-title">${m}</div>
                <div class="notif-upload-current" id="${n}-current" style="font-size:11px;color:#64748b;margin:3px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
                <div class="notif-upload-progress">
                    <div class="notif-upload-bar"><div class="notif-upload-fill" id="${n}-fill"></div></div>
                    <div class="notif-upload-detail">
                        <span class="notif-upload-pct" id="${n}-pct">0%</span>
                        <span class="notif-upload-stats" id="${n}-stats">0 / ${e} ${w}</span>
                    </div>
                </div>
                <div class="notif-item-time">${c()}</div>
            </div>
        `,a.insertBefore(s,a.firstChild),i[n]={el:s,totalFiles:e,completed:0,successCount:0,errorCount:0,lastLabelUpdateTs:0,lastLabelFile:""},r();let h=document.getElementById("notif-wrapper"),f=document.getElementById("notif-bell-btn");return h&&!h.classList.contains("open")&&(h.classList.add("open"),f&&f.classList.add("active")),n;},updateFile:function(e,t,o,n){let a,r=i[e];if(!r)return;"error"===n&&(r.errorCount=(r.errorCount||0)+1);let l=(a=e+"-current",document.getElementById(a));if(l&&"uploading"===n){let e=Date.now();if(!(r.lastLabelFile!==t||e-(r.lastLabelUpdateTs||0)>=300||o>=100))return;l.textContent=t.length>50?"‚Ä¶"+t.slice(-49):t,r.lastLabelFile=t,r.lastLabelUpdateTs=e;}},fileCompleted:function(e,t){let o,n,a,r=i[e];if(!r||(r.completed++,t&&r.successCount++,!(r.completed>=r.totalFiles)&&r.completed%5!=0))return;let l=Math.round(r.completed/r.totalFiles*100),s=(o=e+"-fill",document.getElementById(o)),d=(n=e+"-pct",document.getElementById(n)),c=(a=e+"-stats",document.getElementById(a)),u=(window.i18n?.getCurrentLocale?.()||"en").startsWith("es")?"archivos":"files";s&&(s.style.width=l+"%"),d&&(d.textContent=l+"%"),c&&(c.textContent=`${r.completed} / ${r.totalFiles} ${u}`);},finishBatch:function(e,t,o){let a,r,s=i[e];if(!s)return;let d=(a=e+"-fill",document.getElementById(a));d&&(d.style.width="100%",d.classList.add(t===o?"done":"error"));let c=s.el.querySelector(".notif-item-title"),u=s.el.querySelector(".notif-item-icon"),m=(r=e+"-current",document.getElementById(r));m&&(m.textContent="");let w=window.i18n?.getCurrentLocale?.()||"en",h=w.startsWith("es")?"archivos":"files",f=w.startsWith("es")?`‚úÖ ${t} / ${o} ${h} subidos`:`‚úÖ ${t} / ${o} ${h} uploaded`;c&&(c.textContent=f),u&&(t===o?(u.className="notif-item-icon success",u.innerHTML=l("fa-check-circle")):(u.className="notif-item-icon error",u.innerHTML=l("fa-exclamation-triangle")));let p=document.getElementById("notif-wrapper");p&&p.classList.contains("open")||n();},addNotification:function({icon:e="fa-info-circle",iconClass:t="upload",title:i="",text:o=""}){let a=document.getElementById("notif-panel-body");if(!a)return;let s=document.createElement("div");s.className="notif-item",s.innerHTML=`
            <div class="notif-item-icon ${t}">${l(e)}</div>
            <div class="notif-item-body">
                <div class="notif-item-title">${d(i)}</div>
                <div class="notif-item-text" title="${d(o)}">${d(o)}</div>
                <div class="notif-item-time">${c()}</div>
            </div>
        `,a.insertBefore(s,a.firstChild);let u=document.getElementById("notif-wrapper");u&&u.classList.contains("open")||n(),r();},clear:s};})();window.notifications=e;let t={overlay:null,container:null,icon:null,title:null,label:null,input:null,cancelBtn:null,confirmBtn:null,closeBtn:null,onConfirm:null,onCancel:null,_selectNameOnly:!1,init(){(this.overlay=document.getElementById("input-modal"),this.overlay)?(this.icon=document.getElementById("modal-icon"),this.title=document.getElementById("modal-title"),this.label=document.getElementById("modal-label"),this.input=document.getElementById("modal-input"),this.cancelBtn=document.getElementById("modal-cancel-btn"),this.confirmBtn=document.getElementById("modal-confirm-btn"),this.closeBtn=document.getElementById("modal-close-btn"),this.cancelBtn.addEventListener("click",()=>this.close(!1)),this.closeBtn.addEventListener("click",()=>this.close(!1)),this.confirmBtn.addEventListener("click",()=>this.confirm()),this.overlay.addEventListener("click",e=>{e.target===this.overlay&&this.close(!1);}),this.input.addEventListener("keydown",e=>{"Enter"===e.key?(e.preventDefault(),this.confirm()):"Escape"===e.key&&this.close(!1);})):console.warn("Modal overlay not found");},prompt(e={}){return new Promise(t=>{let{title:i="Input",label:o="",placeholder:n="",value:a="",icon:r="fa-keyboard",confirmText:l=null,cancelText:s=null}=e,d=String(r||"").trim();this.icon&&(this.icon.innerHTML=window.oxiIconFromFaClass?window.oxiIconFromFaClass(`fas ${d}`):""),this.title.textContent=i,this.label.textContent=o,this.input.placeholder=n,this.input.value=a,l?this.confirmBtn.textContent=l:window.i18n&&(this.confirmBtn.textContent=window.i18n.t("actions.confirm")),s?this.cancelBtn.textContent=s:window.i18n&&(this.cancelBtn.textContent=window.i18n.t("actions.cancel")),this.onConfirm=()=>{t(this.input.value.trim()||null);},this.onCancel=()=>t(null),this.open();});},promptNewFolder(){let e=window.i18n?window.i18n.t.bind(window.i18n):e=>e;return this.prompt({title:e("dialogs.new_folder_title")||"New folder",label:e("dialogs.folder_name")||"Folder name",placeholder:e("dialogs.folder_placeholder")||"My folder",icon:"fa-folder-plus",confirmText:e("actions.create")||"Create"});},promptRename(e,t=!1){let i=window.i18n?window.i18n.t.bind(window.i18n):e=>e;return this._selectNameOnly=!t,this.prompt({title:i("dialogs.rename_title")||"Renombrar",label:i("dialogs.new_name")||"Nuevo nombre",placeholder:"",value:e,icon:t?"fa-folder":"fa-file",confirmText:i("actions.rename")||"Renombrar"});},open(){this.overlay&&(this.overlay.style.display="flex",requestAnimationFrame(()=>{this.overlay.classList.add("active");}),setTimeout(()=>{if(this.input.focus(),this._selectNameOnly){let e=this.input.value.lastIndexOf(".");e>0?this.input.setSelectionRange(0,e):this.input.select(),this._selectNameOnly=!1;}else this.input.select();},100));},close(e=!1){this.overlay&&(this.overlay.classList.remove("active"),setTimeout(()=>{this.overlay.style.display="none",!e&&this.onCancel&&this.onCancel(),this.onConfirm=null,this.onCancel=null;},200));},confirm(){this.onConfirm&&this.onConfirm(),this.close(!0);}};document.addEventListener("DOMContentLoaded",()=>{t.init();}),window.Modal=t;let i={initializeContextMenus(){if(!document.getElementById("folder-context-menu")){let e=document.createElement("div");e.className="context-menu",e.id="folder-context-menu",e.innerHTML=`
                <div class="context-menu-item" id="download-folder-option">
                    ${this._icon("download")} <span data-i18n="actions.download">Download</span>
                </div>
                <div class="context-menu-item" id="favorite-folder-option">
                    ${this._icon("star")} <span data-i18n="actions.favorite">Add to favorites</span>
                </div>
                <div class="context-menu-item" id="share-folder-option">
                    ${this._icon("share-alt")} <span data-i18n="actions.share">Share</span>
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" id="rename-folder-option">
                    ${this._icon("pen")} <span data-i18n="actions.rename">Rename</span>
                </div>
                <div class="context-menu-item" id="move-folder-option">
                    ${this._icon("arrows-alt")} <span data-i18n="actions.move">Move to...</span>
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item context-menu-item-danger" id="delete-folder-option">
                    ${this._icon("trash-alt")} <span data-i18n="actions.delete">Delete</span>
                </div>
            `,document.body.appendChild(e);}if(!document.getElementById("file-context-menu")){let e=document.createElement("div");e.className="context-menu",e.id="file-context-menu",e.innerHTML=`
                <div class="context-menu-item" id="view-file-option">
                    ${this._icon("eye")} <span data-i18n="actions.view">View</span>
                </div>
                <div class="context-menu-item" id="download-file-option">
                    ${this._icon("download")} <span data-i18n="actions.download">Download</span>
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" id="favorite-file-option">
                    ${this._icon("star")} <span data-i18n="actions.favorite">Add to favorites</span>
                </div>
                <div class="context-menu-item" id="share-file-option">
                    ${this._icon("share-alt")} <span data-i18n="actions.share">Share</span>
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" id="rename-file-option">
                    ${this._icon("pen")} <span data-i18n="actions.rename">Rename</span>
                </div>
                <div class="context-menu-item" id="move-file-option">
                    ${this._icon("arrows-alt")} <span data-i18n="actions.move">Move to...</span>
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item context-menu-item-danger" id="delete-file-option">
                    ${this._icon("trash-alt")} <span data-i18n="actions.delete">Delete</span>
                </div>
            `,document.body.appendChild(e);}if(!document.getElementById("rename-dialog")){let e=document.createElement("div");e.className="rename-dialog",e.id="rename-dialog",e.innerHTML=`
                <div class="rename-dialog-content">
                    <div class="rename-dialog-header">
                        ${this._icon("pen")}
                        <span data-i18n="dialogs.rename_folder">Rename</span>
                    </div>
                    <div class="rename-dialog-body">
                        <input type="text" id="rename-input" data-i18n-placeholder="dialogs.new_name" placeholder="New name">
                    </div>
                    <div class="rename-dialog-buttons">
                        <button class="btn btn-secondary" id="rename-cancel-btn" data-i18n="actions.cancel">Cancel</button>
                        <button class="btn btn-primary" id="rename-confirm-btn" data-i18n="actions.rename">Rename</button>
                    </div>
                </div>
            `,document.body.appendChild(e);}if(!document.getElementById("move-file-dialog")){let e=document.createElement("div");e.className="rename-dialog",e.id="move-file-dialog",e.innerHTML=`
                <div class="rename-dialog-content">
                    <div class="rename-dialog-header">
                        ${this._icon("arrows-alt")}
                        <span data-i18n="dialogs.move_file">Move</span>
                    </div>
                    <div class="rename-dialog-body">
                        <p style="margin:0 0 12px;color:#718096;font-size:14px" data-i18n="dialogs.select_destination">Select destination folder:</p>
                        <div id="folder-select-container" style="max-height:220px;overflow-y:auto;">
                            <div class="folder-select-item selected" data-folder-id="">
                                ${this._icon("folder")} <span data-i18n="dialogs.root">Root</span>
                            </div>
                        </div>
                    </div>
                    <div class="rename-dialog-buttons">
                        <button class="btn btn-secondary" id="move-cancel-btn" data-i18n="actions.cancel">Cancel</button>
                        <button class="btn btn-primary" id="move-confirm-btn" data-i18n="actions.move_to">Move</button>
                    </div>
                </div>
            `,document.body.appendChild(e);}if(!document.getElementById("share-dialog")){let e=document.createElement("div");e.className="share-dialog",e.id="share-dialog",e.innerHTML=`
                <div class="share-dialog-content">
                    <div class="share-dialog-header">
                        ${this._icon("share-alt")}
                        <span data-i18n="dialogs.share_file">Share file</span>
                    </div>
                    <div class="shared-item-info">
                        <strong>Item:</strong> <span id="shared-item-name"></span>
                    </div>
                    
                    <div id="existing-shares-section" style="display:none; margin: 15px 0;">
                        <h3 data-i18n="dialogs.existing_shares">Existing shared links</h3>
                        <div id="existing-shares-container"></div>
                    </div>
                    
                    <div class="share-options">
                        <h3 data-i18n="dialogs.share_options">Share options</h3>
                        
                        <div class="form-group">
                            <label for="share-password" data-i18n="dialogs.password">Password (optional):</label>
                            <input type="password" id="share-password" placeholder="Protect with password">
                        </div>
                        
                        <div class="form-group">
                            <label for="share-expiration" data-i18n="dialogs.expiration">Expiration date (optional):</label>
                            <input type="date" id="share-expiration">
                        </div>
                        
                        <div class="form-group">
                            <label data-i18n="dialogs.permissions">Permissions:</label>
                            <div class="permission-options">
                                <div class="permission-option">
                                    <input type="checkbox" id="share-permission-read" checked>
                                    <label for="share-permission-read" data-i18n="permissions.read">Read</label>
                                </div>
                                <div class="permission-option">
                                    <input type="checkbox" id="share-permission-write">
                                    <label for="share-permission-write" data-i18n="permissions.write">Write</label>
                                </div>
                                <div class="permission-option">
                                    <input type="checkbox" id="share-permission-reshare">
                                    <label for="share-permission-reshare" data-i18n="permissions.reshare">Allow sharing</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="new-share-section" style="display:none; margin: 15px 0;">
                        <h3 data-i18n="dialogs.generated_link">Generated link</h3>
                        <div class="form-group">
                            <input type="text" id="generated-share-url" readonly>
                            <div class="share-link-actions">
                                <button class="btn btn-small" id="copy-share-btn">
                                    ${this._icon("copy")} <span data-i18n="actions.copy">Copy</span>
                                </button>
                                <button class="btn btn-small" id="notify-share-btn">
                                    ${this._icon("envelope")} <span data-i18n="actions.notify">Notify</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="share-dialog-buttons">
                        <button class="btn btn-secondary" id="share-cancel-btn" data-i18n="actions.cancel">Cancel</button>
                        <button class="btn btn-primary" id="share-confirm-btn" data-i18n="actions.share">Share</button>
                    </div>
                </div>
            `,document.body.appendChild(e),document.getElementById("share-cancel-btn").addEventListener("click",()=>{l.closeShareDialog();}),document.getElementById("share-confirm-btn").addEventListener("click",async()=>{await l.createSharedLink();}),document.getElementById("copy-share-btn").addEventListener("click",async()=>{let e=document.getElementById("generated-share-url").value;await fileSharing.copyLinkToClipboard(e);}),document.getElementById("notify-share-btn").addEventListener("click",()=>{let e=document.getElementById("generated-share-url").value;l.showEmailNotificationDialog(e);});}if(!document.getElementById("notification-dialog")){let e=document.createElement("div");e.className="share-dialog",e.id="notification-dialog",e.innerHTML=`
                <div class="share-dialog-content">
                    <div class="share-dialog-header">
                        ${this._icon("envelope")}
                        <span data-i18n="dialogs.notify">Notify shared link</span>
                    </div>
                    
                    <p><strong>URL:</strong> <span id="notification-share-url"></span></p>
                    
                    <div class="form-group">
                        <label for="notification-email" data-i18n="dialogs.recipient">Recipient:</label>
                        <input type="email" id="notification-email" placeholder="Email address">
                    </div>
                    
                    <div class="form-group">
                        <label for="notification-message" data-i18n="dialogs.message">Message (optional):</label>
                        <textarea id="notification-message" rows="3"></textarea>
                    </div>
                    
                    <div class="share-dialog-buttons">
                        <button class="btn btn-secondary" id="notification-cancel-btn" data-i18n="actions.cancel">Cancel</button>
                        <button class="btn btn-primary" id="notification-send-btn" data-i18n="actions.send">Send</button>
                    </div>
                </div>
            `,document.body.appendChild(e),document.getElementById("notification-cancel-btn").addEventListener("click",()=>{l.closeNotificationDialog();}),document.getElementById("notification-send-btn").addEventListener("click",()=>{l.sendShareNotification();});}window.contextMenus?window.contextMenus.assignMenuEvents():console.warn("contextMenus module not loaded");},setupDragAndDrop(){let e=document.getElementById("dropzone"),t=async e=>{let t=Array.from(e?.items||[]).map(e=>"function"==typeof e.webkitGetAsEntry?e.webkitGetAsEntry():null).filter(Boolean);if(0===t.length)return null;let i=[],o=async(e,t="")=>{if(e){if(e.isFile)return void await new Promise(o=>{e.file(e=>{i.push({file:e,relativePath:`${t}${e.name}`}),o();},()=>o());});if(e.isDirectory){let i=`${t}${e.name}/`,n=e.createReader();for(;;){let e=await new Promise(e=>{n.readEntries(e,()=>e([]));});if(!e||0===e.length)break;for(let t of e)await o(t,i);}}}};for(let e of t)await o(e,"");return i;};e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("active");}),e.addEventListener("dragleave",()=>{e.classList.remove("active");}),e.addEventListener("drop",async i=>{if(i.preventDefault(),i.stopPropagation(),i._oxiHandled=!0,e.classList.remove("active"),i.dataTransfer.files.length>0){let o=await t(i.dataTransfer);if(o&&o.length>0){o.some(e=>e.relativePath&&e.relativePath.includes("/"))?d.uploadFolderEntries(o):d.uploadFiles(o.map(e=>e.file)),setTimeout(()=>{e.style.display="none";},500);return;}Array.from(i.dataTransfer.files).some(e=>e.webkitRelativePath&&e.webkitRelativePath.includes("/"))?d.uploadFolderFiles(i.dataTransfer.files):d.uploadFiles(i.dataTransfer.files);}setTimeout(()=>{e.style.display="none";},500);}),document.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.types.includes("Files")&&(e.style.display="block",e.classList.add("active"));}),document.addEventListener("dragleave",t=>{(t.clientX<=0||t.clientY<=0||t.clientX>=window.innerWidth||t.clientY>=window.innerHeight)&&(e.classList.remove("active"),setTimeout(()=>{e.classList.contains("active")||(e.style.display="none");},100));}),document.addEventListener("drop",async i=>{if(i.preventDefault(),e.classList.remove("active"),!i._oxiHandled){if(i.dataTransfer.files.length>0){let o=await t(i.dataTransfer);if(o&&o.length>0){o.some(e=>e.relativePath&&e.relativePath.includes("/"))?d.uploadFolderEntries(o):d.uploadFiles(o.map(e=>e.file)),setTimeout(()=>{e.style.display="none";},500);return;}Array.from(i.dataTransfer.files).some(e=>e.webkitRelativePath&&e.webkitRelativePath.includes("/"))?d.uploadFolderFiles(i.dataTransfer.files):d.uploadFiles(i.dataTransfer.files);}setTimeout(()=>{e.style.display="none";},500);}});},switchToGridView(){let e=document.getElementById("files-grid"),t=document.getElementById("files-list-view"),i=document.getElementById("grid-view-btn"),o=document.getElementById("list-view-btn");this._disableListVirtualization(),this._hydrateViewIfNeeded("grid"),this._scheduleGridRebuild(),e.style.display="grid",t.style.display="none",i.classList.add("active"),o.classList.remove("active"),window.app.currentView="grid",localStorage.setItem("oxicloud-view","grid");},switchToListView(){let e=document.getElementById("files-grid"),t=document.getElementById("files-list-view"),i=document.getElementById("grid-view-btn"),o=document.getElementById("list-view-btn");this._hydrateViewIfNeeded("list"),this._scheduleListRebuild(),this._disableGridVirtualization(),e.style.display="none",t.style.display="flex",i.classList.remove("active"),o.classList.add("active"),window.app.currentView="list",localStorage.setItem("oxicloud-view","list");},updateBreadcrumb(e){let t=document.querySelector(".breadcrumb");t.innerHTML="";let i=JSON.parse(localStorage.getItem("oxicloud_user")||"{}").username||"",o=document.createElement("span");o.className="breadcrumb-item";let n=(e,t)=>window.i18n&&window.i18n.t?window.i18n.t(e):t;if(i&&window.app.userHomeFolderName&&window.app.userHomeFolderName.includes(i)&&e===window.app.userHomeFolderName)o.textContent=n("breadcrumb.home","Home");else if(e&&e.startsWith("My Folder"))o.textContent=e;else if(o.textContent=n("breadcrumb.home","Home"),e&&e.startsWith("Search:"))return void t.appendChild(o);if(window.app.userHomeFolderId&&o.addEventListener("click",()=>{window.app.currentPath=window.app.userHomeFolderId,this.updateBreadcrumb(window.app.userHomeFolderName||"Home"),window.loadFiles();}),t.appendChild(o),e&&!e.startsWith("Mi Carpeta")&&!e.startsWith("Search:")){let i=document.createElement("span");i.className="breadcrumb-separator",i.textContent=">",t.appendChild(i);let o=document.createElement("span");o.className="breadcrumb-item",o.textContent=e,t.appendChild(o);}},isViewableFile:e=>!!e&&!!e.mime_type&&(!!e.mime_type.startsWith("image/")||"application/pdf"===e.mime_type||!!window.isTextViewable&&window.isTextViewable(e.mime_type)),_icon:(e,t="")=>window.oxiIcon(e,t),_iconFromClass(e,t=""){let i=String(e||"").trim();return i?i.includes("fa-")?window.oxiIconFromFaClass(i,t):window.oxiIcon(i,t):"";},getIconClass:e=>e?({pdf:"file-pdf",doc:"file-word",docx:"file-word",txt:"file-alt",rtf:"file-alt",odt:"file-alt",xls:"file-excel",xlsx:"file-excel",csv:"file-excel",ods:"file-excel",ppt:"file-powerpoint",pptx:"file-powerpoint",odp:"file-powerpoint",jpg:"file-image",jpeg:"file-image",png:"file-image",gif:"file-image",svg:"file-image",webp:"file-image",bmp:"file-image",ico:"file-image",mp4:"file-video",avi:"file-video",mov:"file-video",mkv:"file-video",webm:"file-video",flv:"file-video",mp3:"file-audio",wav:"file-audio",ogg:"file-audio",flac:"file-audio",aac:"file-audio",m4a:"file-audio",zip:"file-archive",rar:"file-archive","7z":"file-archive",tar:"file-archive",gz:"file-archive",js:"file-code",ts:"file-code",py:"file-code",rs:"file-code",java:"file-code",html:"file-code",css:"file-code",json:"file-code",xml:"file-code",sh:"terminal",bash:"terminal",bat:"terminal",md:"file-alt"})[(e.split(".").pop()||"").toLowerCase()]||"file":"file",getIconSpecialClass:e=>e?({pdf:"pdf-icon",doc:"doc-icon",docx:"doc-icon",odt:"doc-icon",rtf:"doc-icon",xls:"spreadsheet-icon",xlsx:"spreadsheet-icon",ods:"spreadsheet-icon",csv:"spreadsheet-icon",ppt:"presentation-icon",pptx:"presentation-icon",odp:"presentation-icon",key:"presentation-icon",jpg:"image-icon",jpeg:"image-icon",png:"image-icon",gif:"image-icon",svg:"image-icon",webp:"image-icon",bmp:"image-icon",ico:"image-icon",heic:"image-icon",heif:"image-icon",avif:"image-icon",tiff:"image-icon",mp4:"video-icon",avi:"video-icon",mkv:"video-icon",mov:"video-icon",wmv:"video-icon",flv:"video-icon",webm:"video-icon",m4v:"video-icon",mp3:"audio-icon",wav:"audio-icon",ogg:"audio-icon",flac:"audio-icon",aac:"audio-icon",wma:"audio-icon",m4a:"audio-icon",opus:"audio-icon",zip:"archive-icon",rar:"archive-icon","7z":"archive-icon",tar:"archive-icon",gz:"archive-icon",bz2:"archive-icon",xz:"archive-icon",exe:"installer-icon",msi:"installer-icon",dmg:"installer-icon",deb:"installer-icon",rpm:"installer-icon",appimage:"installer-icon",py:"code-icon py-icon",rs:"code-icon rust-icon",go:"code-icon go-icon",js:"code-icon js-icon",jsx:"code-icon js-icon",mjs:"code-icon js-icon",ts:"code-icon ts-icon",tsx:"code-icon ts-icon",java:"code-icon java-icon",c:"code-icon c-icon",cpp:"code-icon c-icon",cs:"code-icon cs-icon",rb:"code-icon ruby-icon",php:"code-icon php-icon",swift:"code-icon swift-icon",html:"code-icon html-icon",htm:"code-icon html-icon",css:"code-icon css-icon",scss:"code-icon css-icon",json:"code-icon json-icon",xml:"code-icon html-icon",yaml:"code-icon config-icon",yml:"code-icon config-icon",toml:"code-icon config-icon",ini:"code-icon config-icon",sql:"code-icon sql-icon",vue:"code-icon js-icon",svelte:"code-icon js-icon",sh:"script-icon",bash:"script-icon",zsh:"script-icon",bat:"script-icon",md:"code-icon md-icon",txt:"doc-icon"})[(e.split(".").pop()||"").toLowerCase()]||"":"",showNotification(e,t){if(window.notifications&&"function"==typeof window.notifications.addNotification){let i=String(e||"").toLowerCase(),o="fa-info-circle",n="upload";i.includes("error")||i.includes("failed")||i.includes("fail")?(o="fa-exclamation-circle",n="error"):i.includes("favorite")||i.includes("favorit")||i.includes("fav")?(o="fa-star",n="success"):(i.includes("delete")||i.includes("removed")||i.includes("trash")||i.includes("rename")||i.includes("complete"))&&(o="fa-check-circle",n="success"),window.notifications.addNotification({icon:o,iconClass:n,title:e||"",text:t||""});return;}let i=document.querySelector(".notification");i?(i.querySelector(".notification-title").textContent=e,i.querySelector(".notification-message").textContent=t):((i=document.createElement("div")).className="notification",i.innerHTML=`
                <div class="notification-title">${e}</div>
                <div class="notification-message">${t}</div>
            `,document.body.appendChild(i)),i.style.display="block",setTimeout(()=>{i.style.display="none";},5e3);},closeContextMenu(){let e=document.getElementById("folder-context-menu");e&&(e.style.display="none",window.app.contextMenuTargetFolder=null);},closeFileContextMenu(){let e=document.getElementById("file-context-menu");e&&(e.style.display="none",window.app.contextMenuTargetFile=null);},_items:new Map,_lastFolders:[],_lastFiles:[],_delegationReady:!1,_renderBatchSize:120,_activeRenderTokens:new Map,_virtualListThreshold:350,_virtualListItemHeight:61,_virtualListOverscan:10,_virtualListState:null,_listRebuildTimer:null,_onVirtualListScroll:null,_onVirtualListResize:null,_virtualGridThreshold:450,_virtualGridMinCardWidth:200,_virtualGridOverscanRows:2,_virtualGridState:null,_gridRebuildTimer:null,_onVirtualGridScroll:null,_onVirtualGridResize:null,_getActiveView:()=>window.app&&"list"===window.app.currentView?"list":window.app&&"grid"===window.app.currentView?"grid":"list"===localStorage.getItem("oxicloud-view")?"list":"grid",_getListScrollHost:()=>document.querySelector(".content-area"),_getCombinedListItems(){let e=[];for(let t of this._lastFolders)e.push({kind:"folder",data:t});for(let t of this._lastFiles)e.push({kind:"file",data:t});return e;},_clearListContentKeepingHeader(e){if(!e)return null;let t=e.querySelector(".list-header");return e.innerHTML="",t&&e.appendChild(t),t;},_scheduleListRebuild(){"list"===this._getActiveView()&&(this._listRebuildTimer&&clearTimeout(this._listRebuildTimer),this._listRebuildTimer=setTimeout(()=>{this._listRebuildTimer=null,this._renderListFromCache();},0));},_disableListVirtualization(){let e=this._virtualListState;e&&(e.host&&this._onVirtualListScroll&&e.host.removeEventListener("scroll",this._onVirtualListScroll),this._onVirtualListResize&&window.removeEventListener("resize",this._onVirtualListResize),this._virtualListState=null,this._onVirtualListScroll=null,this._onVirtualListResize=null);},_renderListFromCache(){let e=document.getElementById("files-list-view");if(!e)return;let t=this._getCombinedListItems();if(0===t.length){this._disableListVirtualization(),this._clearListContentKeepingHeader(e);return;}if(t.length<=this._virtualListThreshold){this._disableListVirtualization(),this._clearListContentKeepingHeader(e);let i=document.createDocumentFragment();for(let e of t)i.appendChild("folder"===e.kind?this._createFolderItem(e.data):this._createFileItem(e.data));e.appendChild(i);return;}this._enableListVirtualization(e,t);},_enableListVirtualization(e,t){let i=this._getListScrollHost();if(!i){this._disableListVirtualization(),this._clearListContentKeepingHeader(e);let i=document.createDocumentFragment();for(let e of t)i.appendChild("folder"===e.kind?this._createFolderItem(e.data):this._createFileItem(e.data));e.appendChild(i);return;}this._disableListVirtualization();let o=this._clearListContentKeepingHeader(e),n=o?o.getBoundingClientRect().height:0,a=document.createElement("div");a.className="virtual-list-spacer virtual-list-spacer-top";let r=document.createElement("div");r.className="virtual-list-spacer virtual-list-spacer-bottom",e.appendChild(a),e.appendChild(r),this._virtualListState={listEl:e,host:i,items:t,headerHeight:n,topSpacer:a,bottomSpacer:r,start:-1,end:-1,rafId:0};let l=()=>{let e=this._virtualListState;!e||e.rafId||(e.rafId=requestAnimationFrame(()=>{this._virtualListState&&(this._virtualListState.rafId=0,this._renderVirtualListWindow());}));};this._onVirtualListScroll=l,this._onVirtualListResize=l,i.addEventListener("scroll",this._onVirtualListScroll,{passive:!0}),window.addEventListener("resize",this._onVirtualListResize),this._renderVirtualListWindow(!0);},_renderVirtualListWindow(e=!1){let t=this._virtualListState;if(!t)return;let i=t.listEl.getBoundingClientRect().top-t.host.getBoundingClientRect().top+t.host.scrollTop,o=Math.max(0,t.host.scrollTop-(i+t.headerHeight)),n=Math.max(0,t.host.scrollTop+t.host.clientHeight-(i+t.headerHeight)),a=this._virtualListItemHeight,r=t.items.length,l=Math.floor(o/a)-this._virtualListOverscan,s=Math.ceil(n/a)+this._virtualListOverscan;if(l=Math.max(0,l),s=Math.min(r,s),!e&&l===t.start&&s===t.end)return;t.start=l,t.end=s,t.listEl.querySelectorAll(".file-item").forEach(e=>e.remove());let d=document.createDocumentFragment();for(let e=l;e<s;e++){let i=t.items[e];d.appendChild("folder"===i.kind?this._createFolderItem(i.data):this._createFileItem(i.data));}t.topSpacer.style.height=`${l*a}px`,t.bottomSpacer.style.height=`${Math.max(0,(r-s)*a)}px`,t.bottomSpacer.before(d);},_scheduleGridRebuild(){"grid"===this._getActiveView()&&(this._gridRebuildTimer&&clearTimeout(this._gridRebuildTimer),this._gridRebuildTimer=setTimeout(()=>{this._gridRebuildTimer=null,this._renderGridFromCache();},0));},_disableGridVirtualization(){let e=this._virtualGridState;e&&(e.host&&this._onVirtualGridScroll&&e.host.removeEventListener("scroll",this._onVirtualGridScroll),this._onVirtualGridResize&&window.removeEventListener("resize",this._onVirtualGridResize),this._virtualGridState=null,this._onVirtualGridScroll=null,this._onVirtualGridResize=null);},_getCombinedGridItems(){let e=[];for(let t of this._lastFolders)e.push({kind:"folder",data:t});for(let t of this._lastFiles)e.push({kind:"file",data:t});return e;},_createGridCard(e){return"folder"===e.kind?this._createFolderCard(e.data):this._createFileCard(e.data);},_computeGridColumns(e){let t=window.getComputedStyle(e),i=parseFloat(t.columnGap||t.gap||"20")||20;return{cols:Math.max(1,Math.floor(((e.clientWidth||1)+i)/(this._virtualGridMinCardWidth+i))),gap:i};},_measureGridRowHeight(e,t){if(!t)return 180;let i=this._createGridCard(t);i.style.visibility="hidden",i.style.pointerEvents="none",e.appendChild(i);let o=Math.ceil(i.getBoundingClientRect().height)||180;return i.remove(),o;},_renderGridFromCache(){let e=document.getElementById("files-grid");if(!e)return;let t=this._getCombinedGridItems();if(0===t.length){this._disableGridVirtualization(),e.innerHTML="";return;}if(t.length<=this._virtualGridThreshold){this._disableGridVirtualization(),e.innerHTML="";let i=t.filter(e=>"folder"===e.kind).map(e=>e.data),o=t.filter(e=>"file"===e.kind).map(e=>e.data);this._renderFoldersToView(i,"grid"),this._renderFilesToView(o,"grid");return;}this._enableGridVirtualization(e,t);},_enableGridVirtualization(e,t){let i=this._getListScrollHost();if(!i){this._disableGridVirtualization(),e.innerHTML="";let i=document.createDocumentFragment();for(let e of t)i.appendChild(this._createGridCard(e));e.appendChild(i);return;}this._disableGridVirtualization(),e.innerHTML="";let o=document.createElement("div");o.className="virtual-grid-spacer virtual-grid-spacer-top";let n=document.createElement("div");n.className="virtual-grid-spacer virtual-grid-spacer-bottom",e.appendChild(o),e.appendChild(n);let a=this._computeGridColumns(e),r=this._measureGridRowHeight(e,t[0]);this._virtualGridState={gridEl:e,host:i,items:t,cols:a.cols,gap:a.gap,rowHeight:r,topSpacer:o,bottomSpacer:n,startRow:-1,endRow:-1,rafId:0};let l=()=>{let e=this._virtualGridState;!e||e.rafId||(e.rafId=requestAnimationFrame(()=>{this._virtualGridState&&(this._virtualGridState.rafId=0,this._renderVirtualGridWindow());}));};this._onVirtualGridScroll=l,this._onVirtualGridResize=l,i.addEventListener("scroll",this._onVirtualGridScroll,{passive:!0}),window.addEventListener("resize",this._onVirtualGridResize),this._renderVirtualGridWindow(!0);},_renderVirtualGridWindow(e=!1){let t=this._virtualGridState;if(!t)return;let i=this._computeGridColumns(t.gridEl);(i.cols!==t.cols||Math.abs(i.gap-t.gap)>.5)&&(t.cols=i.cols,t.gap=i.gap,t.startRow=-1,t.endRow=-1);let o=t.gridEl.getBoundingClientRect().top-t.host.getBoundingClientRect().top+t.host.scrollTop,n=t.rowHeight+t.gap,a=Math.max(0,t.host.scrollTop-o),r=Math.max(0,t.host.scrollTop+t.host.clientHeight-o),l=t.items.length,s=Math.ceil(l/t.cols),d=Math.floor(a/n)-this._virtualGridOverscanRows,c=Math.ceil(r/n)+this._virtualGridOverscanRows;if(d=Math.max(0,d),c=Math.min(s,c),!e&&d===t.startRow&&c===t.endRow)return;t.startRow=d,t.endRow=c,t.gridEl.querySelectorAll(".file-card").forEach(e=>e.remove());let u=d*t.cols,m=Math.min(l,c*t.cols),w=document.createDocumentFragment();for(let e=u;e<m;e++)w.appendChild(this._createGridCard(t.items[e]));t.topSpacer.style.height=`${d*n}px`,t.bottomSpacer.style.height=`${Math.max(0,(s-c)*n)}px`,t.bottomSpacer.before(w);},_renderInBatches(e,t,i,o){if(!Array.isArray(e)||0===e.length||!t)return;let n=Date.now()+Math.random();this._activeRenderTokens.set(o,n);let a=this._renderBatchSize,r=0,l=()=>{if(this._activeRenderTokens.get(o)!==n||!t.isConnected)return;let s=document.createDocumentFragment(),d=Math.min(r+a,e.length);for(let t=r;t<d;t++)s.appendChild(i(e[t]));t.appendChild(s),(r=d)<e.length&&requestAnimationFrame(l);};requestAnimationFrame(l);},_renderFoldersToView(e,t){if(!Array.isArray(e)||0===e.length)return;let i="list"===t?document.getElementById("files-list-view"):document.getElementById("files-grid");if(i){if(e.length<=this._renderBatchSize){let o=document.createDocumentFragment();for(let i of e)o.appendChild("list"===t?this._createFolderItem(i):this._createFolderCard(i));i.appendChild(o);return;}this._renderInBatches(e,i,"list"===t?e=>this._createFolderItem(e):e=>this._createFolderCard(e),`folders:${t}`);}},_renderFilesToView(e,t){if(!Array.isArray(e)||0===e.length)return;let i="list"===t?document.getElementById("files-list-view"):document.getElementById("files-grid");if(i){if(e.length<=this._renderBatchSize){let o=document.createDocumentFragment();for(let i of e)o.appendChild("list"===t?this._createFileItem(i):this._createFileCard(i));i.appendChild(o);return;}this._renderInBatches(e,i,"list"===t?e=>this._createFileItem(e):e=>this._createFileCard(e),`files:${t}`);}},_upsertById(e,t){if(!Array.isArray(e)||!t||!t.id)return;let i=e.findIndex(e=>e&&e.id===t.id);i>=0?e[i]=t:e.push(t);},_hydrateViewIfNeeded(e){if(document.querySelector("#files-grid .file-card, #files-list-view .file-item")){if("grid"===e){let e=document.getElementById("files-grid");if(!e||e.children.length>0)return;this._scheduleGridRebuild();return;}if("list"===e){let e=document.getElementById("files-list-view");if(!e||e.querySelector(".file-item"))return;this._scheduleListRebuild();}}},initDelegation(){if(this._delegationReady)return;let e=document.getElementById("files-grid"),t=document.getElementById("files-list-view");if(!e||!t)return;this._delegationReady=!0;let i=this,a=e=>{if(!e)return null;let t=e.dataset.fileId;if(t)return{type:"file",id:t,data:i._items.get(t)};let o=e.dataset.folderId;return o?{type:"folder",id:o,data:i._items.get(o)}:null;},r=e=>{e&&(window.recent&&document.dispatchEvent(new CustomEvent("file-accessed",{detail:{file:e}})),i.isViewableFile(e)&&window.inlineViewer?window.inlineViewer.openFile(e):window.fileOps.downloadFile(e.id,e.name));},l=e=>{window.app.currentPath=e.dataset.folderId,i.updateBreadcrumb(e.dataset.folderName),window.loadFiles();},s=(e,t)=>{"folder"===t.type?window.app.contextMenuTargetFolder={id:t.id,name:e.dataset.folderName,parent_id:e.dataset.parentId||""}:window.app.contextMenuTargetFile={id:t.id,name:e.dataset.fileName,folder_id:e.dataset.folderId||""};};for(let i of(e.addEventListener("click",e=>{let t=e.target.closest(".file-card");if(!t)return;if(e.target.closest(".file-card-more")){e.stopPropagation(),e.preventDefault();let i=a(t);if(!i)return;s(t,i);let o="folder"===i.type?"folder-context-menu":"file-context-menu";n(e.target.closest(".file-card-more"),o);return;}if(e.target.closest(".file-card-checkbox"))return void o(t,e);if(e.target.closest(".favorite-star"))return;let i=a(t);i&&("folder"===i.type?l(t):r(i.data));}),e.addEventListener("dblclick",e=>{e.preventDefault();}),t.addEventListener("click",e=>{if(e.target.closest(".list-header"))return;let t=e.target.closest(".file-item");if(!t)return;if(e.target.closest(".list-item-checkbox")||e.target.closest(".item-checkbox"))return void o(t,e);let i=a(t);i&&("folder"===i.type?l(t):r(i.data));}),[e,t])){let t=i===e?".file-card":".file-item";i.addEventListener("contextmenu",e=>{let i=e.target.closest(t);if(!i)return;e.preventDefault();let o=a(i);if(!o)return;s(i,o);let n="folder"===o.type?"folder-context-menu":"file-context-menu",r=document.getElementById(n);window.contextMenus&&"function"==typeof window.contextMenus.syncFavoriteOptionLabels&&window.contextMenus.syncFavoriteOptionLabels(),r.style.left=`${e.pageX}px`,r.style.top=`${e.pageY}px`,r.style.display="block";}),i.addEventListener("dragstart",o=>{let n=o.target.closest(t);if(!n||i===e&&!n.classList.contains("selected"))return void o.preventDefault();let r=a(n);r?(o.dataTransfer.setData("text/plain",r.id),"folder"===r.type&&o.dataTransfer.setData("application/oxicloud-folder","true"),n.classList.add("dragging")):o.preventDefault();}),i.addEventListener("dragend",e=>{let i=e.target.closest(t);i&&i.classList.remove("dragging"),document.querySelectorAll(".drop-target").forEach(e=>e.classList.remove("drop-target"));}),i.addEventListener("dragover",e=>{let i=e.target.closest(t);!i||i.dataset.fileId||i.dataset.folderId&&(e.preventDefault(),i.classList.add("drop-target"));}),i.addEventListener("dragleave",e=>{let i=e.target.closest(t);i&&!i.dataset.fileId&&i.classList.remove("drop-target");}),i.addEventListener("drop",async e=>{let i=e.target.closest(t);if(!i||i.dataset.fileId)return;let o=i.dataset.folderId;if(!o)return;e.preventDefault(),i.classList.remove("drop-target");let n=e.dataTransfer.getData("text/plain"),a="true"===e.dataTransfer.getData("application/oxicloud-folder");if(n)if(a){if(n===o)return void alert("You cannot move a folder to itself");await d.moveFolder(n,o);}else await d.moveFile(n,o);});}},_bindStarClick(e){let t=e.querySelector(".favorite-star");t&&t.addEventListener("click",e=>{if(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),!window.favorites)return;let i=t.dataset.itemId,o=t.dataset.itemType,n=t.dataset.itemName;t.classList.contains("active")?(this.setFavoriteVisualState(i,o,!1),window.favorites.removeFromFavorites(i,o)):(this.setFavoriteVisualState(i,o,!0),window.favorites.addToFavorites(i,n,o)),window.contextMenus&&"function"==typeof window.contextMenus.syncFavoriteOptionLabels&&window.contextMenus.syncFavoriteOptionLabels();});},setFavoriteVisualState(e,t,i){let o="folder"===t?`.file-card[data-folder-id="${e}"]`:`.file-card[data-file-id="${e}"]`,n="folder"===t?`.file-item[data-folder-id="${e}"]`:`.file-item[data-file-id="${e}"]`,a=document.querySelector(o),r=a?a.querySelector(".favorite-star"):null;if(r){r.classList.toggle("active",!!i);let e=r.querySelector("svg"),t=window.OxiIcons&&window.OxiIcons.star,o=window.OxiIcons&&window.OxiIcons["star-outline"],n=i?t:o;if(e&&n){let t=e.querySelector("path");t&&t.setAttribute("d",n[1]),e.setAttribute("viewBox",`0 0 ${n[0]} 512`);}}let l=document.querySelector(n);if(l){let e=l.querySelector(".name-cell");if(e){let t=e.querySelector(".favorite-star-inline");if(i&&!t){let i=document.createElement("span");i.innerHTML=this._icon("star","favorite-star-inline"),(t=i.firstElementChild)&&e.appendChild(t);}else!i&&t&&t.remove();}}},_createFolderCard(e){let t=document.createElement("div");t.className="file-card",t.dataset.folderId=e.id,t.dataset.folderName=e.name,t.dataset.parentId=e.parent_id||"";let i=window.favorites&&window.favorites.isFavorite(e.id,"folder");return t.innerHTML=`
            <div class="file-card-checkbox">${this._icon("check")}</div>
            <button class="file-card-more">${this._icon("ellipsis-v")}</button>
            <button class="favorite-star${i?" active":""}" data-item-id="${e.id}" data-item-type="folder" data-item-name="${w(e.name)}">
                ${this._icon(i?"star":"star-outline")}
            </button>
            <div class="file-icon folder-icon">
                ${this._icon("folder")}
            </div>
            <div class="file-name">${w(e.name)}</div>
            <div class="file-info">Folder</div>
        `,""!==window.app.currentPath&&t.setAttribute("draggable","true"),this._bindStarClick(t),t;},_createFolderItem(e){let t=document.createElement("div");t.className="file-item",t.dataset.folderId=e.id,t.dataset.folderName=e.name,t.dataset.parentId=e.parent_id||"";let i=window.favorites&&window.favorites.isFavorite(e.id,"folder"),o=window.formatDateTime(e.modified_at);return""!==window.app.currentPath&&t.setAttribute("draggable","true"),t.innerHTML=`
            <div class="list-item-checkbox"><input type="checkbox" class="item-checkbox"></div>
            <div class="name-cell">
                <div class="file-icon folder-icon">
                    ${this._icon("folder")}
                </div>
                <span>${w(e.name)}</span>
                ${i?this._icon("star","favorite-star-inline"):""}
            </div>
            <div class="type-cell">${window.i18n?window.i18n.t("files.file_types.folder"):"Folder"}</div>
            <div class="size-cell">--</div>
            <div class="date-cell">${o}</div>
        `,t;},_createFileCard(e){let t=e.icon_class||this.getIconClass(e.name),i=e.icon_special_class||this.getIconSpecialClass(e.name),o=window.favorites&&window.favorites.isFavorite(e.id,"file"),n=window.formatDateTime(e.modified_at),a=document.createElement("div");return a.className="file-card",a.dataset.fileId=e.id,a.dataset.fileName=e.name,a.dataset.folderId=e.folder_id||"",a.setAttribute("draggable","true"),a.innerHTML=`
            <div class="file-card-checkbox">${this._icon("check")}</div>
            <button class="file-card-more">${this._icon("ellipsis-v")}</button>
            <button class="favorite-star${o?" active":""}" data-item-id="${e.id}" data-item-type="file" data-item-name="${w(e.name)}">
                ${this._icon(o?"star":"star-outline")}
            </button>
            <div class="file-icon ${i}">
                ${this._iconFromClass(t)}
            </div>
            <div class="file-name">${w(e.name)}</div>
            <div class="file-info">Modified ${n.split(" ")[0]}</div>
        `,this._bindStarClick(a),a;},_createFileItem(e){let t=e.icon_class||this.getIconClass(e.name),i=e.icon_special_class||this.getIconSpecialClass(e.name),o=e.category||"",n=o?window.i18n&&window.i18n.t(`files.file_types.${o.toLowerCase()}`)||o:window.i18n?window.i18n.t("files.file_types.document"):"Document",a=e.size_formatted||window.formatFileSize(e.size),r=window.formatDateTime(e.modified_at),l=window.favorites&&window.favorites.isFavorite(e.id,"file"),s=document.createElement("div");return s.className="file-item",s.dataset.fileId=e.id,s.dataset.fileName=e.name,s.dataset.folderId=e.folder_id||"",s.setAttribute("draggable","true"),s.innerHTML=`
            <div class="list-item-checkbox"><input type="checkbox" class="item-checkbox"></div>
            <div class="name-cell">
                <div class="file-icon ${i}">
                    ${this._iconFromClass(t)}
                </div>
                <span>${w(e.name)}</span>
                ${l?this._icon("star","favorite-star-inline"):""}
            </div>
            <div class="type-cell">${n}</div>
            <div class="size-cell">${a}</div>
            <div class="date-cell">${r}</div>
        `,s;},renderFolders(e){this._delegationReady||this.initDelegation();let t=Array.isArray(e)?e:[];for(let e of(this._lastFolders=t.slice(),t))this._items.set(e.id,e);let i=this._getActiveView();"list"===i?this._scheduleListRebuild():"grid"===i?this._scheduleGridRebuild():this._renderFoldersToView(t,i);},renderFiles(e){this._delegationReady||this.initDelegation();let t=Array.isArray(e)?e:[];for(let e of(this._lastFiles=t.slice(),t))this._items.set(e.id,e);let i=this._getActiveView();"list"===i?this._scheduleListRebuild():"grid"===i?this._scheduleGridRebuild():this._renderFilesToView(t,i);},addFolderToView(e){if(this._delegationReady||this.initDelegation(),document.querySelector(`.file-card[data-folder-id="${e.id}"]`)||document.querySelector(`.file-item[data-folder-id="${e.id}"]`))return void console.log(`Folder ${e.name} (${e.id}) already exists in the view, not duplicating`);this._items.set(e.id,e),this._upsertById(this._lastFolders,e);let t=this._getActiveView();"list"===t?this._scheduleListRebuild():"grid"===t?this._scheduleGridRebuild():this._renderFoldersToView([e],t);},addFileToView(e){if(this._delegationReady||this.initDelegation(),document.querySelector(`.file-card[data-file-id="${e.id}"]`)||document.querySelector(`.file-item[data-file-id="${e.id}"]`))return void console.log(`File ${e.name} (${e.id}) already exists in the view, not duplicating`);this._items.set(e.id,e),this._upsertById(this._lastFiles,e);let t=this._getActiveView();"list"===t?this._scheduleListRebuild():"grid"===t?this._scheduleGridRebuild():this._renderFilesToView([e],t);}};function o(e,t){window.multiSelect?window.multiSelect.handleItemClick(e,t):e.classList.toggle("selected");}function n(e,t){document.querySelectorAll(".context-menu").forEach(e=>e.style.display="none");let i=document.getElementById(t);if(!i)return;let o=e.getBoundingClientRect(),n=o.right-200+window.scrollX,a=o.bottom+4+window.scrollY;n<8&&(n=8),a+300>window.innerHeight+window.scrollY&&(a=o.top-4+window.scrollY),window.contextMenus&&"function"==typeof window.contextMenus.syncFavoriteOptionLabels&&window.contextMenus.syncFavoriteOptionLabels(),i.style.left=`${n}px`,i.style.top=`${a}px`,i.style.display="block";}function a(){let e=document.getElementById("selection-rect");e||((e=document.createElement("div")).id="selection-rect",e.className="selection-rect",document.body.appendChild(e));let t=!1,i=0,o=0,n=document.querySelector(".files-container")||document.getElementById("files-grid");n&&(n.addEventListener("mousedown",n=>{0!==n.button||n.target.closest(".file-card")||n.target.closest(".context-menu")||n.target.closest(".upload-dropdown")||n.target.closest("button")||n.target.closest("input")||n.target.closest(".breadcrumb")||(t=!0,i=n.clientX,o=n.clientY,e.style.left=`${i}px`,e.style.top=`${o}px`,e.style.width="0px",e.style.height="0px",e.style.display="none",n.preventDefault());}),document.addEventListener("mousemove",n=>{if(!t)return;let a=n.clientX,r=n.clientY,l=Math.min(i,a),s=Math.min(o,r),d=Math.abs(a-i),c=Math.abs(r-o);(d>5||c>5)&&(e.style.display="block"),e.style.left=`${l}px`,e.style.top=`${s}px`,e.style.width=`${d}px`,e.style.height=`${c}px`;let u={left:l,top:s,right:l+d,bottom:s+c};document.querySelectorAll("#files-grid .file-card").forEach(e=>{let t=e.getBoundingClientRect();if(t.left<u.right&&t.right>u.left&&t.top<u.bottom&&t.bottom>u.top){if(e.classList.add("selected"),window.multiSelect){let t=window.multiSelect._extractInfo(e);t&&window.multiSelect.select(t.id,t.name,t.type,t.parentId);}}else if(e.classList.remove("selected"),window.multiSelect){let t=window.multiSelect._extractInfo(e);t&&window.multiSelect.deselect(t.id);}});}),document.addEventListener("mouseup",()=>{t&&(t=!1,e.style.display="none",window.multiSelect&&window.multiSelect._syncUI());}));}function r({title:e,message:t,confirmText:i,cancelText:o,danger:n=!0}={}){let a=i||(window.i18n?window.i18n.t("actions.delete"):"Delete"),l=o||(window.i18n?window.i18n.t("actions.cancel"):"Cancel"),s=e||(window.i18n?window.i18n.t("dialogs.confirm_title"):"Confirm action");return new Promise(e=>{let i=document.getElementById("confirm-dialog-overlay");i&&i.remove();let o=document.createElement("div");o.id="confirm-dialog-overlay",o.className="confirm-dialog",o.innerHTML=`
            <div class="confirm-dialog-content">
                <div class="confirm-dialog-icon">
                    ${window.oxiIcon(n?"exclamation-triangle":"question-circle")}
                </div>
                <div class="confirm-dialog-title">${s}</div>
                <div class="confirm-dialog-message">${t||""}</div>
                <div class="confirm-dialog-buttons">
                    <button class="btn btn-secondary confirm-dialog-cancel">${l}</button>
                    <button class="btn ${n?"btn-danger":"btn-primary"} confirm-dialog-ok">${a}</button>
                </div>
            </div>
        `,document.body.appendChild(o),requestAnimationFrame(()=>{o.classList.add("active");});let r=t=>{o.classList.remove("active"),setTimeout(()=>o.remove(),200),e(t);};o.querySelector(".confirm-dialog-cancel").addEventListener("click",()=>r(!1)),o.querySelector(".confirm-dialog-ok").addEventListener("click",()=>r(!0)),o.addEventListener("click",e=>{e.target===o&&r(!1);});});}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a(),window.toggleCardSelection=o,window.showContextMenuAtElement=n,window.initRubberBandSelection=a,window.showConfirmDialog=r,window.ui=i;let l={_icon:(e,t="")=>window.oxiIcon(e,t),_setFavoriteOptionLabel(e,t){let i=document.getElementById(e);if(!i)return;let o=i.querySelector("span");o&&(o.textContent=window.i18n?window.i18n.t(t?"actions.unfavorite":"actions.favorite"):t?"Remove from favorites":"Add to favorites");},syncFavoriteOptionLabels(){if(!window.favorites)return;let e=window.app&&window.app.contextMenuTargetFile,t=window.app&&window.app.contextMenuTargetFolder;if(e){let t=window.favorites.isFavorite(e.id,"file");this._setFavoriteOptionLabel("favorite-file-option",t);}if(t){let e=window.favorites.isFavorite(t.id,"folder");this._setFavoriteOptionLabel("favorite-folder-option",e);}},assignMenuEvents(){document.getElementById("download-folder-option").addEventListener("click",()=>{window.app.contextMenuTargetFolder&&window.fileOps.downloadFolder(window.app.contextMenuTargetFolder.id,window.app.contextMenuTargetFolder.name),window.ui.closeContextMenu();}),document.getElementById("favorite-folder-option").addEventListener("click",async()=>{if(window.app.contextMenuTargetFolder){if(window.loadFavoritesModule)try{await window.loadFavoritesModule();}catch(e){console.error("Could not load favorites module:",e),window.ui&&window.ui.showNotification&&window.ui.showNotification("Error","Could not load favorites"),window.ui.closeContextMenu();return;}let e=window.app.contextMenuTargetFolder;window.favorites&&window.favorites.isFavorite(e.id,"folder")?await window.favorites.removeFromFavorites(e.id,"folder")&&window.ui&&"function"==typeof window.ui.setFavoriteVisualState&&window.ui.setFavoriteVisualState(e.id,"folder",!1):await window.favorites.addToFavorites(e.id,e.name,"folder",e.parent_id)&&window.ui&&"function"==typeof window.ui.setFavoriteVisualState&&window.ui.setFavoriteVisualState(e.id,"folder",!0),this.syncFavoriteOptionLabels();}window.ui.closeContextMenu();}),document.getElementById("rename-folder-option").addEventListener("click",()=>{window.app.contextMenuTargetFolder&&this.showRenameDialog(window.app.contextMenuTargetFolder),window.ui.closeContextMenu();}),document.getElementById("move-folder-option").addEventListener("click",()=>{window.app.contextMenuTargetFolder&&this.showMoveDialog(window.app.contextMenuTargetFolder,"folder"),window.ui.closeContextMenu();}),document.getElementById("share-folder-option").addEventListener("click",()=>{let e=window.app.contextMenuTargetFolder;e&&this.showShareDialog(e,"folder"),window.ui.closeContextMenu();}),document.getElementById("delete-folder-option").addEventListener("click",async()=>{let e=window.app.contextMenuTargetFolder;window.ui.closeContextMenu(),e&&await window.fileOps.deleteFolder(e.id,e.name);}),document.getElementById("view-file-option").addEventListener("click",()=>{if(window.app.contextMenuTargetFile){let e=window.app.contextMenuTargetFile,t=localStorage.getItem("oxicloud_token"),i=t?{Authorization:`Bearer ${t}`}:{};fetch(`/api/files/${e.id}?metadata=true`,{headers:i}).then(e=>e.json()).then(t=>{window.ui&&window.ui.isViewableFile(t)&&window.inlineViewer?window.inlineViewer.openFile(t):window.fileOps.downloadFile(e.id,e.name);}).catch(t=>{console.error("Error fetching file details:",t),window.fileOps.downloadFile(e.id,e.name);});}window.ui.closeFileContextMenu();}),document.getElementById("download-file-option").addEventListener("click",()=>{window.app.contextMenuTargetFile&&window.fileOps.downloadFile(window.app.contextMenuTargetFile.id,window.app.contextMenuTargetFile.name),window.ui.closeFileContextMenu();}),document.getElementById("favorite-file-option").addEventListener("click",async()=>{if(window.app.contextMenuTargetFile){if(window.loadFavoritesModule)try{await window.loadFavoritesModule();}catch(e){console.error("Could not load favorites module:",e),window.ui&&window.ui.showNotification&&window.ui.showNotification("Error","Could not load favorites"),window.ui.closeFileContextMenu();return;}let e=window.app.contextMenuTargetFile;window.favorites&&window.favorites.isFavorite(e.id,"file")?await window.favorites.removeFromFavorites(e.id,"file")&&window.ui&&"function"==typeof window.ui.setFavoriteVisualState&&window.ui.setFavoriteVisualState(e.id,"file",!1):await window.favorites.addToFavorites(e.id,e.name,"file",e.folder_id)&&window.ui&&"function"==typeof window.ui.setFavoriteVisualState&&window.ui.setFavoriteVisualState(e.id,"file",!0),this.syncFavoriteOptionLabels();}window.ui.closeFileContextMenu();}),document.getElementById("rename-file-option").addEventListener("click",()=>{window.app.contextMenuTargetFile&&this.showRenameFileDialog(window.app.contextMenuTargetFile),window.ui.closeFileContextMenu();}),document.getElementById("move-file-option").addEventListener("click",()=>{window.app.contextMenuTargetFile&&this.showMoveDialog(window.app.contextMenuTargetFile,"file"),window.ui.closeFileContextMenu();}),document.getElementById("share-file-option").addEventListener("click",()=>{let e=window.app.contextMenuTargetFile;e&&this.showShareDialog(e,"file"),window.ui.closeFileContextMenu();}),document.getElementById("delete-file-option").addEventListener("click",async()=>{let e=window.app.contextMenuTargetFile;window.ui.closeFileContextMenu(),e&&await window.fileOps.deleteFile(e.id,e.name);});let e=document.getElementById("rename-cancel-btn"),t=document.getElementById("rename-confirm-btn"),i=document.getElementById("rename-input");e.addEventListener("click",this.closeRenameDialog),t.addEventListener("click",()=>l.renameItem()),i.addEventListener("keyup",e=>{"Enter"===e.key?l.renameItem():"Escape"===e.key&&this.closeRenameDialog();});let o=document.getElementById("move-cancel-btn"),n=document.getElementById("move-confirm-btn");o.addEventListener("click",this.closeMoveDialog),n.addEventListener("click",async()=>{if("batch"===window.app.moveDialogMode&&window.multiSelect){let e=window.app.selectedTargetFolderId,t=window.app.batchMoveItems||[],i=t.filter(e=>"file"===e.type).map(e=>e.id),o=t.filter(t=>"folder"===t.type&&t.id!==e).map(e=>e.id),n=0,a=0;try{if(i.length>0){let t=await fetch("/api/batch/files/move",{method:"POST",headers:{...s(),"Content-Type":"application/json"},body:JSON.stringify({file_ids:i,target_folder_id:e})}),o=await t.json();n+=o.stats?.successful||0,a+=o.stats?.failed||0;}if(o.length>0){let t=await fetch("/api/batch/folders/move",{method:"POST",headers:{...s(),"Content-Type":"application/json"},body:JSON.stringify({folder_ids:o,target_folder_id:e})}),i=await t.json();n+=i.stats?.successful||0,a+=i.stats?.failed||0;}}catch(e){console.error("Batch move error:",e),a++;}this.closeMoveDialog(),window.multiSelect.clear(),window.loadFiles(),a>0?window.ui.showNotification("Batch move",`${n} moved, ${a} failed`):window.ui.showNotification("Items moved",`${n} item${1!==n?"s":""} moved successfully`);return;}"file"===window.app.moveDialogMode&&window.app.contextMenuTargetFile?await window.fileOps.moveFile(window.app.contextMenuTargetFile.id,window.app.selectedTargetFolderId)&&this.closeMoveDialog():"folder"===window.app.moveDialogMode&&window.app.contextMenuTargetFolder&&await window.fileOps.moveFolder(window.app.contextMenuTargetFolder.id,window.app.selectedTargetFolderId)&&this.closeMoveDialog();});},showRenameDialog(e){let t=document.getElementById("rename-input"),i=document.getElementById("rename-dialog");window.app.renameMode="folder",window.app.renameTarget=e,t.value=e.name;let o=i.querySelector(".rename-dialog-header span");o&&(o.textContent=window.i18n?window.i18n.t("dialogs.rename_folder"):"Rename folder"),i.style.display="flex",t.focus(),t.select();},showRenameFileDialog(e){let t=document.getElementById("rename-input"),i=document.getElementById("rename-dialog");window.app.renameMode="file",window.app.renameTarget=e,t.value=e.name;let o=i.querySelector(".rename-dialog-header span");o&&(o.textContent=window.i18n?window.i18n.t("dialogs.rename_file"):"Rename file"),i.style.display="flex",t.focus(),t.select();},closeRenameDialog(){document.getElementById("rename-dialog").style.display="none",window.app.contextMenuTargetFolder=null,window.app.renameTarget=null;},async showMoveDialog(e,t){window.app.moveDialogMode=t,window.app.selectedTargetFolderId="";let i=document.getElementById("move-file-dialog").querySelector(".rename-dialog-header"),o="file"===t?window.i18n?window.i18n.t("dialogs.move_file"):"Move file":window.i18n?window.i18n.t("dialogs.move_folder"):"Move folder";i.innerHTML=`${this._icon("arrows-alt")} <span>${o}</span>`,await this.loadAllFolders(e.id,t),document.getElementById("move-file-dialog").style.display="flex";},closeMoveDialog(){document.getElementById("move-file-dialog").style.display="none",window.app.contextMenuTargetFile=null,window.app.contextMenuTargetFolder=null;},async renameItem(){let e=document.getElementById("rename-input").value.trim();if(!e)return void alert(window.i18n?window.i18n.t("errors.empty_name"):"Name cannot be empty");let t=window.app.renameTarget;t?"file"===window.app.renameMode?await window.fileOps.renameFile(t.id,e)&&(l.closeRenameDialog(),window.loadFiles()):"folder"===window.app.renameMode&&await window.fileOps.renameFolder(t.id,e)&&(l.closeRenameDialog(),window.loadFiles()):console.error("No rename target available");},renameFolder:()=>l.renameItem(),async loadAllFolders(e,t){try{let i=localStorage.getItem("oxicloud_token"),o=i?{Authorization:`Bearer ${i}`}:{},n=await fetch("/api/folders",{headers:o});if(n.ok){let i=await n.json(),o=document.getElementById("folder-select-container");o.innerHTML=`
                    <div class="folder-select-item selected" data-folder-id="">
                        ${this._icon("folder")} <span data-i18n="dialogs.root">Root</span>
                    </div>
                `,window.app.selectedTargetFolderId="",Array.isArray(i)&&i.forEach(i=>{if("folder"===t&&i.id===e||"file"===t&&window.app.contextMenuTargetFile&&i.id===window.app.contextMenuTargetFile.folder_id||"folder"===t&&window.app.contextMenuTargetFolder&&i.id===window.app.contextMenuTargetFolder.parent_id)return;let n=document.createElement("div");n.className="folder-select-item",n.dataset.folderId=i.id,n.innerHTML=`${this._icon("folder")} ${w(i.name)}`,n.addEventListener("click",()=>{document.querySelectorAll(".folder-select-item").forEach(e=>{e.classList.remove("selected");}),n.classList.add("selected"),window.app.selectedTargetFolderId=i.id;}),o.appendChild(n);});let a=o.querySelector(".folder-select-item");a.addEventListener("click",()=>{document.querySelectorAll(".folder-select-item").forEach(e=>{e.classList.remove("selected");}),a.classList.add("selected"),window.app.selectedTargetFolderId="";}),window.i18n&&window.i18n.translateElement&&window.i18n.translateElement(o);}}catch(e){console.error("Error loading folders:",e);}},async showShareDialog(e,t){try{let i=document.getElementById("share-dialog");if(!i){console.error("Share dialog element not found in DOM"),window.ui.showNotification("Error","Share dialog not available");return;}let o=i.querySelector(".share-dialog-header");if(o){let e=o.querySelector("span"),i="file"===t?window.i18n?window.i18n.t("dialogs.share_file"):"Share file":window.i18n?window.i18n.t("dialogs.share_folder"):"Share folder";e?e.textContent=i:o.textContent=i;}let n=document.getElementById("shared-item-name");n&&(n.textContent=e.name);let a=document.getElementById("share-password"),l=document.getElementById("share-expiration");a&&(a.value=""),l&&(l.value="");let s=document.getElementById("share-permission-read"),d=document.getElementById("share-permission-write"),c=document.getElementById("share-permission-reshare");s&&(s.checked=!0),d&&(d.checked=!1),c&&(c.checked=!1),window.app.shareDialogItem=e,window.app.shareDialogItemType=t;let u=await window.fileSharing.getSharedLinksForItem(e.id,t),m=document.getElementById("existing-shares-container");m.innerHTML="",u.length>0?(document.getElementById("existing-shares-section").style.display="block",u.forEach(e=>{let t=document.createElement("div");t.className="existing-share-item";let i=e.expires_at?`Expires: ${window.fileSharing.formatExpirationDate(e.expires_at)}`:"No expiration",o=document.createElement("div");o.className="share-url",o.textContent=e.url,t.appendChild(o);let n=document.createElement("div");if(n.className="share-info",e.has_password){let e=document.createElement("span");e.className="share-protected",e.innerHTML=`${this._icon("lock")} Password protected`,n.appendChild(e);}let a=document.createElement("span");a.className="share-expiration",a.textContent=i,n.appendChild(a),t.appendChild(n);let r=document.createElement("div");r.className="share-actions";let l=document.createElement("button");l.className="btn btn-small copy-link-btn",l.dataset.shareUrl=e.url,l.innerHTML=`${this._icon("copy")} Copy`,r.appendChild(l);let s=document.createElement("button");s.className="btn btn-small btn-danger delete-link-btn",s.dataset.shareId=e.id,s.innerHTML=`${this._icon("trash")} Delete`,r.appendChild(s),t.appendChild(r),m.appendChild(t);}),document.querySelectorAll(".copy-link-btn").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();let i=e.getAttribute("data-share-url");window.fileSharing.copyLinkToClipboard(i);});}),document.querySelectorAll(".delete-link-btn").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();let i=e.getAttribute("data-share-id");r({title:window.i18n?window.i18n.t("dialogs.confirm_delete_share"):"Delete link",message:window.i18n?window.i18n.t("dialogs.confirm_delete_share_msg"):"Are you sure you want to delete this shared link?",confirmText:window.i18n?window.i18n.t("actions.delete"):"Delete"}).then(async t=>{t&&(await window.fileSharing.removeSharedLink(i),e.closest(".existing-share-item").remove(),0===m.children.length&&(document.getElementById("existing-shares-section").style.display="none"));});});})):document.getElementById("existing-shares-section").style.display="none";let w=document.getElementById("new-share-section");w&&(w.style.display="none"),i.style.display="flex",console.log("Share dialog opened for",t,e.name);}catch(e){console.error("Error opening share dialog:",e),window.ui.showNotification("Error","Could not open share dialog");}},async createSharedLink(){if(!window.app.shareDialogItem||!window.app.shareDialogItemType)return void window.ui.showNotification("Error","Could not share the item");let e=document.getElementById("share-password").value,t=document.getElementById("share-expiration").value,i=document.getElementById("share-permission-read").checked,o=document.getElementById("share-permission-write").checked,n=document.getElementById("share-permission-reshare").checked,a=window.app.shareDialogItem,r=window.app.shareDialogItemType,l={item_id:a.id,item_name:a.name||null,item_type:r,password:e||null,expires_at:t?Math.floor(new Date(t).getTime()/1e3):null,permissions:{read:i,write:o,reshare:n}};try{let e=localStorage.getItem("oxicloud_token"),t={"Content-Type":"application/json"};e&&(t.Authorization=`Bearer ${e}`);let i=await fetch("/api/shares",{method:"POST",headers:t,body:JSON.stringify(l)});if(!i.ok){let e=await i.json().catch(()=>({}));throw Error(e.error||`Server error ${i.status}`);}let o=await i.json(),n=document.getElementById("generated-share-url");n&&(n.value=o.url,document.getElementById("new-share-section").style.display="block",n.focus(),n.select()),window.ui.showNotification(window.i18n?window.i18n.t("notifications.link_created"):"Link created",window.i18n?window.i18n.t("notifications.share_success"):"Shared link created successfully");}catch(e){console.error("Error creating shared link:",e),window.ui.showNotification("Error",e.message||"Could not create shared link");}},showEmailNotificationDialog(e){document.getElementById("notification-share-url").textContent=e,document.getElementById("notification-email").value="",document.getElementById("notification-message").value="",window.app.notificationShareUrl=e,document.getElementById("notification-dialog").style.display="flex";},sendShareNotification(){let e=document.getElementById("notification-email").value.trim(),t=document.getElementById("notification-message").value.trim(),i=window.app.notificationShareUrl;if(!e||!i||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))return void window.ui.showNotification("Error","Please enter a valid email address");try{window.fileSharing.sendShareNotification(i,e,t),document.getElementById("notification-dialog").style.display="none";}catch(e){console.error("Error sending notification:",e),window.ui.showNotification("Error","Could not send notification");}},closeShareDialog(){let e=document.getElementById("share-dialog");e&&(e.style.display="none"),window.app.shareDialogItem=null,window.app.shareDialogItemType=null;},closeNotificationDialog(){document.getElementById("notification-dialog").style.display="none",window.app.notificationShareUrl=null;}};function s(){let e=localStorage.getItem("oxicloud_token"),t={};return e&&(t.Authorization=`Bearer ${e}`),t;}window.contextMenus=l;let d={_currentBatchId:null,_isUploading:!1,_initUploadToast(e,t){this._currentBatchId=window.notifications?window.notifications.addUploadBatch(e,t):null;},_finishUploadToast(e,t){window.notifications&&this._currentBatchId&&window.notifications.finishBatch(this._currentBatchId,e,t);},_canReadFileBlob:e=>new Promise(t=>{try{let i=new FileReader;i.onload=()=>t(!0),i.onerror=()=>t(!1),i.readAsArrayBuffer(e.slice(0,1));}catch(e){t(!1);}}),_uploadFileXHR:(e,t,i,o=12e4)=>new Promise(n=>{let a=new XMLHttpRequest,r=window.notifications;a.timeout=o;let l=Math.max(2*o,18e4),s=-1,d=!1,c=null,u=null,m=(e,o)=>{if(r&&t)try{r.updateFile(t,i,e,o);}catch(e){console.warn("Notification update failed for upload row:",i,e);}},w=e=>{d||(d=!0,c&&(clearTimeout(c),c=null),u&&(clearTimeout(u),u=null),n(e));},h=()=>{c&&clearTimeout(c),c=setTimeout(()=>{try{a.abort();}catch(e){}m(0,"error"),w({ok:!1,isTimeout:!0,errorMsg:`Upload stalled for ${Math.round(o/1e3)}s`});},o);};h(),u=setTimeout(()=>{try{a.abort();}catch(e){}m(0,"error"),w({ok:!1,isTimeout:!0,errorMsg:`Upload hard timeout after ${Math.round(l/1e3)}s`});},l),a.upload.addEventListener("progress",e=>{if(h(),e.lengthComputable){let t=Math.round(e.loaded/e.total*100);(100===t||t-s>=10)&&(s=t,m(t,"uploading"));}}),a.addEventListener("readystatechange",()=>{a.readyState>1&&a.readyState<4&&h();}),a.addEventListener("load",()=>{if(a.status>=200&&a.status<300){m(100,"done");let e=null;try{e=JSON.parse(a.responseText);}catch(e){}w({ok:!0,data:e});}else{m(0,"error");let e=null,t=!1;try{let i=JSON.parse(a.responseText);e=i.error||null,t="QuotaExceeded"===i.error_type||507===a.status;}catch(e){}w({ok:!1,errorMsg:e,isQuotaError:t});}}),a.addEventListener("error",()=>{m(0,"error"),w({ok:!1});}),a.addEventListener("abort",()=>{m(0,"error"),w({ok:!1,isTimeout:!0,errorMsg:`Upload aborted/stalled: ${i}`});}),a.addEventListener("timeout",()=>{m(0,"error"),w({ok:!1,isTimeout:!0,errorMsg:`Timeout after ${Math.round(o/1e3)}s`});}),a.open("POST","/api/files/upload");let f=localStorage.getItem("oxicloud_token");f&&a.setRequestHeader("Authorization",`Bearer ${f}`),a.setRequestHeader("Cache-Control","no-cache, no-store, must-revalidate");try{a.send(e);}catch(e){m(0,"error"),w({ok:!1,errorMsg:`Client send() failed: ${e?.message||"unknown error"}`});}}),async _uploadFileFetch(e,t=6e4){let i=new AbortController,o=setTimeout(()=>i.abort(),t);try{let t=await fetch("/api/files/upload",{method:"POST",headers:{...s(),"Cache-Control":"no-cache, no-store, must-revalidate"},body:e,signal:i.signal,cache:"no-store"}),o="";try{o=await t.text();}catch(e){}let n=null;try{n=JSON.parse(o);}catch(e){}if(t.ok)return{ok:!0,data:n};let a=n&&"object"==typeof n?n.error||null:o||null,r=n&&"object"==typeof n&&"QuotaExceeded"===n.error_type||507===t.status;return{ok:!1,errorMsg:a,isQuotaError:r};}catch(i){let e=i?.name==="AbortError";return{ok:!1,isTimeout:e,errorMsg:e?`Timeout after ${Math.round(t/1e3)}s`:`Fetch upload failed: ${i?.message||"network error"}`};}finally{clearTimeout(o);}},async uploadFiles(e){let t=Array.from(e||[]);if(0!==t.length){if(this._isUploading)return void console.warn("Upload already in progress, ignoring duplicate call");this._isUploading=!0;try{let e=document.querySelector(".progress-fill"),i=document.querySelector(".upload-progress");i&&(i.style.display="block"),e&&(e.style.width="0%");let o=[],n=[];for(let e of t)await this._canReadFileBlob(e)?o.push(e):n.push(e.name||"Unnamed entry");let a=o.length;if(n.length>0&&window.notifications){let e=window.i18n?.getCurrentLocale?.()||"en",t=e.startsWith("es")?"Entradas omitidas":"Entries skipped",i=e.startsWith("es")?`Se omitieron ${n.length} carpeta(s)/entrada(s) no legibles. Usa "Subir carpeta".`:`${n.length} unreadable folder/entry items were skipped. Use "Upload folder".`;window.notifications.addNotification({icon:"fa-folder-open",iconClass:"upload",title:t,text:i});}if(0===a){i&&(i.style.display="none"),this._isUploading=!1;return;}this._initUploadToast(a);let r=this._currentBatchId,l=0,s=0;for(let t=0;t<a;t++){let i=o[t],n=new FormData,d=window.app.currentPath||window.app.userHomeFolderId;d&&n.append("folder_id",d),n.append("file",i),console.log(`Uploading file to folder: ${d||"root"}`,{file:i.name,size:i.size});let c=await this._uploadFileXHR(n,r,i.name);if(l++,e&&(e.style.width=l/a*100+"%"),window.notifications&&r)try{window.notifications.fileCompleted(r,c.ok);}catch(e){console.warn("Batch progress update failed:",e);}if(c.ok)s++,console.log(`Successfully uploaded ${i.name}`,c.data);else if(console.error(`Upload error for ${i.name}`),c.isTimeout&&window.notifications&&window.notifications.addNotification({icon:"fa-clock",iconClass:"error",title:i.name,text:c.errorMsg||"Upload timeout"}),c.isQuotaError){let e=c.errorMsg||window.i18n?.t("storage_quota_exceeded")||"Storage quota exceeded";window.notifications&&window.notifications.addNotification({icon:"fa-exclamation-triangle",iconClass:"error",title:i.name,text:e});break;}}if(this._finishUploadToast(s,a),"function"==typeof window.refreshUserData)try{await window.refreshUserData();}catch(e){}try{await window.loadFiles({forceRefresh:!0});}catch(e){console.error("Error reloading files:",e);}let d=document.getElementById("dropzone");d&&(d.style.display="none"),i&&(i.style.display="none");}finally{this._isUploading=!1;}}},async uploadFolderFiles(e){let t=Array.from(e||[]).map(e=>({file:e,relativePath:e.webkitRelativePath||e.name}));await this.uploadFolderEntries(t);},async uploadFolderEntries(e){let t=Array.isArray(e)?e:[];if(0===t.length)return;if(this._isUploading)return void console.warn("Upload already in progress, ignoring duplicate call");this._isUploading=!0;let i=document.querySelector(".progress-fill"),o=document.querySelector(".upload-progress");o&&(o.style.display="block"),i&&(i.style.width="0%");try{let e=[];for(let i of t)await this._canReadFileBlob(i.file)?e.push(i):console.warn(`Skipping unreadable folder entry: ${i.relativePath||i.file?.name}`);let n=e.length;if(0===n){o&&(o.style.display="none");return;}let a=window.app.currentPath||window.app.userHomeFolderId,r=new Map;r.set("",a);let l=new Set;for(let t of e){let e=(t.relativePath||t.file.name).split("/");for(let t=1;t<e.length;t++){let i=e.slice(0,t).join("/");l.add(i);}}for(let e of[...l].sort((e,t)=>e.split("/").length-t.split("/").length)){let t=e.split("/"),i=t[t.length-1],o=t.slice(0,-1).join("/"),n=r.get(o)||a;try{let t=await fetch("/api/folders",{method:"POST",headers:{...s(),"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate"},body:JSON.stringify({name:i,parent_id:n})});if(t.ok){let i=await t.json();r.set(e,i.id),console.log(`Created folder: ${e} -> ${i.id}`);}else console.error(`Error creating folder ${e}:`,await t.text());}catch(t){console.error(`Network error creating folder ${e}:`,t);}}let d=[...new Set(e.map(e=>(e.relativePath||e.file.name).split("/")[0]||"").filter(Boolean))],c=window.i18n?.getCurrentLocale?.()||"en",u=d.length<=1?d[0]||"":c.startsWith("es")?`${d.length} carpetas`:`${d.length} folders`;this._initUploadToast(n,u);let m=this._currentBatchId,w=0,h=0,f=!1,p=async t=>{if(f)return;let o=e[t],l=o.file,s=o.relativePath||l.name,d={ok:!1,errorMsg:"Unknown client error"};try{let e=s.split("/").slice(0,-1).join("/"),i=r.get(e)||a,o=l;if(0===l.size)try{let e=await Promise.race([l.arrayBuffer(),new Promise((e,t)=>setTimeout(()=>t(Error("read-timeout")),2e3))]);o=new Blob([e],{type:l.type||"application/octet-stream"});}catch{if(console.warn(`[SKIP] #${t} ${s} ‚Äî cannot read 0-byte file (FIFO/pipe?), skipping`),w++,h++,window.notifications&&m)try{window.notifications.fileCompleted(m,!0);}catch(e){}return;}let n=new FormData;n.append("folder_id",i),n.append("file",o,l.name);let c=0===l.size?3e3:1e4;console.log(`[UPLOAD START] #${t} ${s} (${l.size} bytes, timeout=${c}ms)`),d=await this._uploadFileFetch(n,c),console.log(`[UPLOAD END]   #${t} ${s} ok=${d.ok}${d.errorMsg?" err="+d.errorMsg:""}`);}catch(e){d={ok:!1,errorMsg:`Client exception: ${e?.message||"unknown"}`},console.error(`[UPLOAD EXCEPTION] #${t} ${s}:`,e);}if(w++,window.notifications&&m)try{window.notifications.fileCompleted(m,d.ok);}catch(e){}i&&w%10==0&&(i.style.width=w/n*100+"%"),(w%50==0||w===n)&&console.log(`Progress: ${w}/${n} (${h} ok)`),d.ok?h++:d.isQuotaError&&(f=!0,window.notifications&&window.notifications.addNotification({icon:"fa-exclamation-triangle",iconClass:"error",title:l.name,text:d.errorMsg||"Storage quota exceeded"}));},g=0,v=async()=>{for(;g<n&&!f;){let e=g++;await p(e);}},y=[];for(let e=0;e<Math.min(10,n);e++)y.push(v());if(await Promise.all(y),this._finishUploadToast(h,n),"function"==typeof window.refreshUserData)try{await window.refreshUserData();}catch(e){}try{await window.loadFiles({forceRefresh:!0});}catch(e){console.error("Error reloading files:",e);}let b=document.getElementById("dropzone");b&&(b.style.display="none"),o&&(o.style.display="none");}finally{this._isUploading=!1;}},async createFolder(e){try{console.log("Creating folder with name:",e);let t=await fetch("/api/folders",{method:"POST",headers:{...s(),"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate"},body:JSON.stringify({name:e,parent_id:window.app.currentPath||window.app.userHomeFolderId||null})});if(t.ok){let i=await t.json();console.log("Folder created successfully:",i),window.ui.addFolderToView(i),window.ui.showNotification("Folder created",`"${e}" created successfully`);}else{let e=await t.text();console.error("Create folder error:",e),window.ui.showNotification("Error","Error creating the folder");}}catch(e){console.error("Error creating folder:",e),window.ui.showNotification("Error","Error creating the folder");}},async moveFile(e,t){try{let i=await fetch(`/api/files/${e}/move`,{method:"PUT",headers:{...s(),"Content-Type":"application/json"},body:JSON.stringify({folder_id:""===t?null:t})});if(i.ok)return await window.loadFiles(),window.ui.showNotification("File moved","File moved successfully"),!0;{let e="Unknown error";try{e=(await i.json()).error||"Unknown error";}catch(t){e="Error processing server response";}return window.ui.showNotification("Error",`Error moving the file: ${e}`),!1;}}catch(e){return console.error("Error moving file:",e),window.ui.showNotification("Error","Error moving the file"),!1;}},async moveFolder(e,t){try{let i=await fetch(`/api/folders/${e}/move`,{method:"PUT",headers:{...s(),"Content-Type":"application/json"},body:JSON.stringify({parent_id:""===t?null:t})});if(i.ok)return await window.loadFiles(),window.ui.showNotification("Folder moved","Folder moved successfully"),!0;{let e="Unknown error";try{e=(await i.json()).error||"Unknown error";}catch(t){e="Error processing server response";}return window.ui.showNotification("Error",`Error moving the folder: ${e}`),!1;}}catch(e){return console.error("Error moving folder:",e),window.ui.showNotification("Error","Error moving the folder"),!1;}},async renameFile(e,t){try{console.log(`Renaming file ${e} to "${t}"`);let i=await fetch(`/api/files/${e}/rename`,{method:"PUT",headers:{...s(),"Content-Type":"application/json"},body:JSON.stringify({name:t})});if(console.log("Response status:",i.status),i.ok)return window.ui.showNotification(window.i18n?window.i18n.t("notifications.file_renamed"):"File renamed",window.i18n?window.i18n.t("notifications.file_renamed_to",{name:t}):`File renamed to "${t}"`),!0;{let e=await i.text();console.error("Error response:",e);let t="Unknown error";try{t=JSON.parse(e).error||i.statusText;}catch(o){t=e||i.statusText;}return window.ui.showNotification("Error",`Error renaming the file: ${t}`),!1;}}catch(e){return console.error("Error renaming file:",e),window.ui.showNotification("Error","Error renaming the file"),!1;}},async renameFolder(e,t){try{console.log(`Renaming folder ${e} to "${t}"`);let i=await fetch(`/api/folders/${e}/rename`,{method:"PUT",headers:{...s(),"Content-Type":"application/json"},body:JSON.stringify({name:t})});if(console.log("Response status:",i.status),i.ok)return window.ui.showNotification("Folder renamed",`Folder renamed to "${t}"`),!0;{let e=await i.text();console.error("Error response:",e);let t="Unknown error";try{t=JSON.parse(e).error||i.statusText;}catch(o){t=e||i.statusText;}return window.ui.showNotification("Error",`Error renaming the folder: ${t}`),!1;}}catch(e){return console.error("Error renaming folder:",e),window.ui.showNotification("Error","Error renaming the folder"),!1;}},async deleteFile(e,t){if(!await r({title:window.i18n?window.i18n.t("dialogs.confirm_delete"):"Move to trash",message:window.i18n?window.i18n.t("dialogs.confirm_delete_file",{name:t}):`Are you sure you want to move the file "${t}" to trash?`,confirmText:window.i18n?window.i18n.t("actions.delete"):"Delete"}))return!1;try{if((await fetch(`/api/trash/files/${e}`,{method:"DELETE",headers:s()})).ok)return window.loadFiles(),window.ui.showNotification("File moved to trash",`"${t}" moved to trash`),!0;if((await fetch(`/api/files/${e}`,{method:"DELETE",headers:s()})).ok)return window.loadFiles(),window.ui.showNotification("File deleted",`"${t}" deleted successfully`),!0;return window.ui.showNotification("Error","Error deleting the file"),!1;}catch(e){return console.error("Error deleting file:",e),window.ui.showNotification("Error","Error deleting the file"),!1;}},async deleteFolder(e,t){if(!await r({title:window.i18n?window.i18n.t("dialogs.confirm_delete"):"Move to trash",message:window.i18n?window.i18n.t("dialogs.confirm_delete_folder",{name:t}):`Are you sure you want to move the folder "${t}" and all its contents to trash?`,confirmText:window.i18n?window.i18n.t("actions.delete"):"Delete"}))return!1;try{if((await fetch(`/api/trash/folders/${e}`,{method:"DELETE",headers:s()})).ok)return window.app.currentPath===e&&(window.app.currentPath="",window.ui.updateBreadcrumb("")),window.loadFiles(),window.ui.showNotification("Folder moved to trash",`"${t}" moved to trash`),!0;if((await fetch(`/api/folders/${e}`,{method:"DELETE",headers:s()})).ok)return window.app.currentPath===e&&(window.app.currentPath="",window.ui.updateBreadcrumb("")),window.loadFiles(),window.ui.showNotification("Folder deleted",`"${t}" deleted successfully`),!0;return window.ui.showNotification("Error","Error deleting the folder"),!1;}catch(e){return console.error("Error deleting folder:",e),window.ui.showNotification("Error","Error deleting the folder"),!1;}},async getTrashItems(){try{let e=await fetch("/api/trash",{headers:s()});if(e.ok)return await e.json();return console.error("Error fetching trash items:",e.statusText),[];}catch(e){return console.error("Error fetching trash items:",e),[];}},async restoreFromTrash(e){try{if((await fetch(`/api/trash/${e}/restore`,{method:"POST",headers:{...s(),"Content-Type":"application/json"},body:JSON.stringify({})})).ok)return window.ui.showNotification("Item restored","Item restored successfully"),!0;return window.ui.showNotification("Error","Error restoring the item"),!1;}catch(e){return console.error("Error restoring item from trash:",e),window.ui.showNotification("Error","Error restoring the item"),!1;}},async deletePermanently(e){if(!await r({title:window.i18n?window.i18n.t("dialogs.confirm_permanent_delete"):"Delete permanently",message:window.i18n?window.i18n.t("dialogs.confirm_permanent_delete_msg"):"Are you sure you want to permanently delete this item? This action cannot be undone.",confirmText:window.i18n?window.i18n.t("actions.delete_permanently"):"Delete permanently"}))return!1;try{if((await fetch(`/api/trash/${e}`,{method:"DELETE",headers:s()})).ok)return window.ui.showNotification("Item deleted","Item permanently deleted"),!0;return window.ui.showNotification("Error","Error deleting the item"),!1;}catch(e){return console.error("Error deleting item permanently:",e),window.ui.showNotification("Error","Error deleting the item"),!1;}},async emptyTrash(){if(!await r({title:window.i18n?window.i18n.t("dialogs.confirm_empty_trash"):"Empty trash",message:window.i18n?window.i18n.t("trash.empty_confirm"):"Are you sure you want to empty the trash? This action will permanently delete all items.",confirmText:window.i18n?window.i18n.t("actions.empty_trash"):"Empty trash"}))return!1;try{if((await fetch("/api/trash/empty",{method:"DELETE",headers:s()})).ok)return window.ui.showNotification("Trash emptied","The trash has been emptied successfully"),!0;return window.ui.showNotification("Error","Error emptying the trash"),!1;}catch(e){return console.error("Error emptying trash:",e),window.ui.showNotification("Error","Error emptying the trash"),!1;}},async downloadFile(e,t){try{let i=await fetch(`/api/files/${e}`,{headers:s()});if(i.ok){let e=await i.blob(),o=URL.createObjectURL(e),n=document.createElement("a");n.href=o,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o);}else window.ui.showNotification("Error","Error downloading the file");}catch(e){console.error("Error downloading file:",e),window.ui.showNotification("Error","Error downloading the file");}},async downloadFolder(e,t){try{window.ui.showNotification("Preparing download","Preparing the folder for download...");let i=await fetch(`/api/folders/${e}/download?format=zip`,{headers:s()});if(i.ok){let e=await i.blob(),o=URL.createObjectURL(e),n=document.createElement("a");n.href=o,n.download=`${t}.zip`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o);}else window.ui.showNotification("Error","Error downloading the folder");}catch(e){console.error("Error downloading folder:",e),window.ui.showNotification("Error","Error downloading the folder");}}};window.fileOps=d;let c={_selected:new Map,_lastClickedIndex:-1,_barVisible:!1,_savedHeaderHTML:"",get count(){return this._selected.size;},get items(){return Array.from(this._selected.values());},get hasSelection(){return this._selected.size>0;},get files(){return this.items.filter(e=>"file"===e.type);},get folders(){return this.items.filter(e=>"folder"===e.type);},_t(e,t){if(window.i18n&&"function"==typeof window.i18n.t){let i=window.i18n.t(e,t);if(i&&i!==e)return i;}return null;},_icon:(e,t="")=>window.oxiIcon?window.oxiIcon(e,t):"",toggle(e,t,i,o){return this._selected.has(e)?(this._selected.delete(e),!1):(this._selected.set(e,{id:e,name:t,type:i,parentId:o}),!0);},select(e,t,i,o){this._selected.set(e,{id:e,name:t,type:i,parentId:o});},deselect(e){this._selected.delete(e);},clear(){this._selected.clear(),this._lastClickedIndex=-1,document.querySelectorAll(".file-card.selected, .file-item.selected").forEach(e=>e.classList.remove("selected")),document.querySelectorAll(".item-checkbox").forEach(e=>e.checked=!1),this._syncUI();},selectAll(){this._selectAllInContainer("files-grid",".file-card"),this._selectAllInContainer("files-list-view",".file-item"),this._syncUI();},toggleAll(){let e=this._getAllVisibleItems();this._selected.size>=e.length&&e.length>0?this.clear():this.selectAll();},_selectElement(e){let t=this._extractInfo(e);t&&(this.select(t.id,t.name,t.type,t.parentId),e.classList.add("selected"));},_selectAllInContainer(e,t){let i=document.getElementById(e);i&&i.querySelectorAll(t).forEach(e=>this._selectElement(e));},_getAllVisibleItems(){let e=document.getElementById("files-grid");return e&&"none"!==e.style.display?[...e.querySelectorAll(".file-card")]:[...document.querySelectorAll("#files-list-view .file-item")];},_extractInfo:e=>e.dataset.folderId&&void 0!==e.dataset.folderName?{id:e.dataset.folderId,name:e.dataset.folderName,type:"folder",parentId:e.dataset.parentId||""}:e.dataset.fileId?{id:e.dataset.fileId,name:e.dataset.fileName,type:"file",parentId:e.dataset.folderId||""}:null,handleItemClick(e,t){let i=this._getAllVisibleItems(),o=i.indexOf(e),n=this._extractInfo(e);if(!n)return;let a="folder"===n.type?`[data-folder-id="${n.id}"]`:`[data-file-id="${n.id}"]`,r=[...document.querySelectorAll(a)].find(t=>t!==e);if(t&&t.shiftKey&&this._lastClickedIndex>=0&&o>=0){let e=Math.min(this._lastClickedIndex,o),t=Math.max(this._lastClickedIndex,o);for(let o=e;o<=t;o++){this._selectElement(i[o]);let e=this._extractInfo(i[o]);if(e){let t="folder"===e.type?`[data-folder-id="${e.id}"]`:`[data-file-id="${e.id}"]`;document.querySelectorAll(t).forEach(e=>e.classList.add("selected"));}}}else{let t=this.toggle(n.id,n.name,n.type,n.parentId);e.classList.toggle("selected",t),r&&r.classList.toggle("selected",t);}this._lastClickedIndex=o,this._syncUI();},_buildSelectionBarHTML(e){let t=1===e?this._t("batch.one_selected")||"1 item selected":this._t("batch.n_selected",{count:e})||`${e} items selected`,i=this._t("batch.add_favorites")||"Add to favorites",o=this._t("batch.move_copy")||"Move or copy",n=this._t("actions.download")||"Download",a=this._t("actions.delete")||"Delete";return`
            <div class="list-header-checkbox">
                <input type="checkbox" id="select-all-checkbox" title="Toggle all" checked>
            </div>
            <div class="batch-selection-info">
                <span class="batch-bar-count">${t}</span>
                <div class="batch-bar-actions">
                    <button class="batch-btn" id="batch-fav" title="${i}">
                        ${this._icon("star")}
                        <span>${i}</span>
                    </button>
                    <button class="batch-btn" id="batch-move" title="${o}">
                        ${this._icon("arrows-alt")}
                        <span>${o}</span>
                    </button>
                    <button class="batch-btn" id="batch-download" title="${n}">
                        ${this._icon("download")}
                        <span>${n}</span>
                    </button>
                    <button class="batch-btn batch-btn-danger" id="batch-delete" title="${a}">
                        ${this._icon("trash-alt")}
                        <span>${a}</span>
                    </button>
                </div>
            </div>
        `;},_ensureGridBar(){if(document.getElementById("batch-grid-bar"))return;let e=document.createElement("div");e.id="batch-grid-bar",e.className="batch-action-bar";let t=document.querySelector(".files-container");t&&t.insertBefore(e,t.firstChild);},_syncUI(){let e=document.querySelector(".list-header"),t=this._selected.size;if(e&&!this._savedHeaderHTML&&(this._savedHeaderHTML=e.innerHTML),t>0){if(this._barVisible=!0,e){e.classList.add("selection-mode"),e.innerHTML=this._buildSelectionBarHTML(t);let i=document.getElementById("select-all-checkbox");i&&i.addEventListener("change",()=>this.toggleAll()),this._wireBarButtons();}this._ensureGridBar();let i=document.getElementById("batch-grid-bar");if(i){let e=document.getElementById("files-grid");if(e&&"none"!==e.style.display){i.classList.add("visible"),i.innerHTML=`
                        <div class="batch-bar-left">
                            <button class="batch-bar-close" id="batch-grid-close" title="Cancel selection">
                                ${this._icon("times")}
                            </button>
                            <span class="batch-bar-count">${1===t?this._t("batch.one_selected")||"1 item selected":this._t("batch.n_selected",{count:t})||`${t} items selected`}</span>
                        </div>
                        <div class="batch-bar-actions">
                            <button class="batch-btn" id="batch-fav" title="Add to favorites">
                                ${this._icon("star")}
                                <span>${this._t("batch.add_favorites")||"Add to favorites"}</span>
                            </button>
                            <button class="batch-btn" id="batch-move" title="Move or copy">
                                ${this._icon("arrows-alt")}
                                <span>${this._t("batch.move_copy")||"Move or copy"}</span>
                            </button>
                            <button class="batch-btn" id="batch-download" title="Download">
                                ${this._icon("download")}
                                <span>${this._t("actions.download")||"Download"}</span>
                            </button>
                            <button class="batch-btn batch-btn-danger" id="batch-delete" title="Delete">
                                ${this._icon("trash-alt")}
                                <span>${this._t("actions.delete")||"Delete"}</span>
                            </button>
                        </div>
                    `;let e=document.getElementById("batch-grid-close");e&&e.addEventListener("click",()=>this.clear()),this._wireBarButtons();}else i.classList.remove("visible");}}else{if(this._barVisible=!1,e){e.classList.remove("selection-mode"),this._savedHeaderHTML&&(e.innerHTML=this._savedHeaderHTML);let t=document.getElementById("select-all-checkbox");t&&t.addEventListener("change",()=>this.toggleAll()),window.i18n&&window.i18n.translateElement&&window.i18n.translateElement(e);}let t=document.getElementById("batch-grid-bar");t&&t.classList.remove("visible");}this._syncItemCheckboxes(),this._barVisible||this._syncSelectAllCheckbox();},_wireBarButtons(){let e=document.getElementById("batch-delete"),t=document.getElementById("batch-move"),i=document.getElementById("batch-download"),o=document.getElementById("batch-fav");e&&(e.onclick=()=>this.batchDelete()),t&&(t.onclick=()=>this.batchMove()),i&&(i.onclick=()=>this.batchDownload()),o&&(o.onclick=()=>this.batchFavorites());},_syncItemCheckboxes(){document.querySelectorAll(".file-item").forEach(e=>{let t=e.querySelector(".item-checkbox");t&&(t.checked=e.classList.contains("selected"));});},_syncSelectAllCheckbox(){let e=document.getElementById("select-all-checkbox");if(!e)return;let t=this._getAllVisibleItems();0===t.length?(e.checked=!1,e.indeterminate=!1):this._selected.size>=t.length?(e.checked=!0,e.indeterminate=!1):this._selected.size>0?(e.checked=!1,e.indeterminate=!0):(e.checked=!1,e.indeterminate=!1);},async batchDelete(){let e=this.items;if(0===e.length)return;let t=e.length,i=1===t?this._t("dialogs.confirm_delete_file",{name:e[0].name})||`Are you sure you want to move "${e[0].name}" to trash?`:this._t("batch.confirm_delete",{count:t})||`Are you sure you want to move ${t} items to trash?`;if(!await r({title:this._t("dialogs.confirm_delete")||"Move to trash",message:i,confirmText:this._t("actions.delete")||"Delete"}))return;let o=e.filter(e=>"file"===e.type).map(e=>e.id),n=e.filter(e=>"folder"===e.type).map(e=>e.id);try{let e=await fetch("/api/batch/trash",{method:"POST",headers:{...s(),"Content-Type":"application/json"},body:JSON.stringify({file_ids:o,folder_ids:n})}),t=await e.json(),i=t.stats?.successful||0,a=t.stats?.failed||0;this.clear(),window.loadFiles(),a>0?window.ui.showNotification("Batch delete",`${i} moved to trash, ${a} failed`):window.ui.showNotification("Moved to trash",`${i} item${1!==i?"s":""} moved to trash`);}catch(e){console.error("Batch trash error:",e),window.ui.showNotification("Error","Could not move items to trash"),this.clear(),window.loadFiles();}},async batchMove(){let e=this.items;if(0===e.length)return;window.app.moveDialogMode="batch",window.app.batchMoveItems=e,window.app.selectedTargetFolderId="";let t=document.getElementById("move-file-dialog"),i=t.querySelector(".rename-dialog-header"),o=e.length,n=this._t("batch.move_title",{count:o})||`Move ${o} item${1!==o?"s":""}`;i.innerHTML=`${this._icon("arrows-alt")} <span>${n}</span>`;let a=e.filter(e=>"folder"===e.type).map(e=>e.id);await l.loadAllFolders(a[0]||null,"batch"),t.style.display="flex";},async batchDownload(){let e=this.items;if(0!==e.length){window.ui.showNotification("Preparing download","Creating ZIP archive...");try{let t=e.filter(e=>"file"===e.type).map(e=>e.id),i=e.filter(e=>"folder"===e.type).map(e=>e.id),o=await fetch("/api/batch/download",{method:"POST",headers:{...s(),"Content-Type":"application/json"},body:JSON.stringify({file_ids:t,folder_ids:i})});if(!o.ok)throw Error(`Server returned ${o.status}`);let n=await o.blob(),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download=`oxicloud-download-${Date.now()}.zip`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a);}catch(e){console.error("Batch download error:",e),window.ui.showNotification("Error","Could not download selected items");}}},async batchFavorites(){let e=this.items;if(0===e.length||!window.favorites)return;let t=e.filter(e=>!window.favorites.isFavorite(e.id,e.type));if(0===t.length){this.clear(),window.ui.showNotification(this._t("favorites.add")||"Favorites","All selected items are already favorites");return;}try{let e=await fetch("/api/favorites/batch",{method:"POST",headers:{...s(),"Content-Type":"application/json"},body:JSON.stringify({items:t.map(e=>({item_id:e.id,item_type:e.type}))})});if(!e.ok)throw Error(`Server returned ${e.status}`);let i=await e.json(),o=i.stats?.inserted||0;i.favorites&&window.favorites._replaceCacheFromResponse?window.favorites._replaceCacheFromResponse(i.favorites):await window.favorites._fetchFromServer(),this.clear(),"function"==typeof window.loadFiles&&window.loadFiles(),o>0?window.ui.showNotification(this._t("favorites.add")||"Added to favorites",`${o} item${1!==o?"s":""} added to favorites`):window.ui.showNotification(this._t("favorites.add")||"Favorites","All selected items are already favorites");}catch(e){console.error("Batch favorites error:",e),window.ui.showNotification("Error","Could not add items to favorites");}},init(){this._injectListHeaderCheckbox(),this._hookGlobalDeselect(),document.addEventListener("keydown",e=>{if(!e.target.closest("input, textarea, [contenteditable], .rename-dialog, .share-dialog, .confirm-dialog")){if((e.ctrlKey||e.metaKey)&&"a"===e.key){let t=document.getElementById("files-grid");t&&t.closest(".files-container")&&(e.preventDefault(),this.selectAll());}"Escape"===e.key&&this.hasSelection&&this.clear(),"Delete"===e.key&&this.hasSelection&&this.batchDelete();}});},_injectListHeaderCheckbox(){let e=document.getElementById("select-all-checkbox");e&&e.addEventListener("change",()=>this.toggleAll());},_hookGlobalDeselect(){document.addEventListener("click",e=>{!e.target.closest(".file-card, .file-item, .context-menu, .batch-action-bar, .list-header.selection-mode, .about-modal, .rename-dialog, .share-dialog, .confirm-dialog, .modal-overlay, input, button")&&this.hasSelection&&this.clear();});}};function u(e,t=""){return window.oxiIcon(e,t);}window.multiSelect=c;class m{constructor(){this.setupViewer(),this.currentFile=null;}setupViewer(){if(document.getElementById("inline-viewer-modal"))return;if(!document.body){console.warn("Document body not available yet for inline viewer, will retry later"),setTimeout(()=>this.setupViewer(),200);return;}let e=document.createElement("div");e.id="inline-viewer-modal",e.className="inline-viewer-modal",e.innerHTML=`
      <div class="inline-viewer-content">
        <div class="inline-viewer-header">
          <div class="inline-viewer-title">File Viewer</div>
          <button class="inline-viewer-close">${u("times")}</button>
        </div>
        <div class="inline-viewer-container"></div>
        <div class="inline-viewer-toolbar">
          <button class="inline-viewer-download">${u("download")} Download</button>
          <div class="inline-viewer-controls">
            <button class="inline-viewer-zoom-out" title="Zoom Out">${u("search-minus")}</button>
            <button class="inline-viewer-zoom-reset" title="Reset Zoom">${u("expand")}</button>
            <button class="inline-viewer-zoom-in" title="Zoom In">${u("search-plus")}</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e),e.querySelector(".inline-viewer-close").addEventListener("click",()=>{this.closeViewer();}),e.querySelector(".inline-viewer-download").addEventListener("click",()=>{this.currentFile&&this.downloadFile(this.currentFile);}),e.querySelector(".inline-viewer-zoom-in").addEventListener("click",()=>{this.zoomImage(1.2);}),e.querySelector(".inline-viewer-zoom-out").addEventListener("click",()=>{this.zoomImage(.8);}),e.querySelector(".inline-viewer-zoom-reset").addEventListener("click",()=>{this.resetZoom();}),document.addEventListener("keydown",t=>{"Escape"===t.key&&e.classList.contains("active")&&this.closeViewer();}),e.addEventListener("click",t=>{t.target===e&&this.closeViewer();}),console.log("Inline viewer initialized");}openFile(e){console.log("Opening file:",e),this.currentFile=e;let t=document.getElementById("inline-viewer-modal"),i=t.querySelector(".inline-viewer-container"),o=t.querySelector(".inline-viewer-title");i.innerHTML="",o.textContent=e.name;let n=t.querySelector(".inline-viewer-controls");if(e.mime_type&&e.mime_type.startsWith("image/")){n.style.display="flex";let t=document.createElement("div");t.className="inline-viewer-loader",t.innerHTML=u("spinner","oxi-icon-spin"),i.appendChild(t),this.createBlobUrlViewer(e,"image",i,t);}else if(e.mime_type&&"application/pdf"===e.mime_type){n.style.display="none";let t=document.createElement("div");t.className="inline-viewer-loader",t.innerHTML=u("spinner","oxi-icon-spin"),i.appendChild(t),this.createBlobUrlViewer(e,"pdf",i,t);}else if(e.mime_type&&this.isTextViewable(e.mime_type)){n.style.display="none";let t=document.createElement("div");t.className="inline-viewer-loader",t.innerHTML=u("spinner","oxi-icon-spin"),i.appendChild(t),this.createTextViewer(e,i,t);}else{n.style.display="none";let e=document.createElement("div");e.className="inline-viewer-message",e.innerHTML=`
        <div class="inline-viewer-icon">${u("file")}</div>
        <div class="inline-viewer-text">
          <p>This file type cannot be previewed.</p>
          <p>Click "Download" to get the file.</p>
        </div>
      `,i.appendChild(e);}t.classList.add("active");}isTextViewable(e){return!!window.isTextViewable&&window.isTextViewable(e);}async createTextViewer(e,t,i){try{console.log("Creating text viewer for:",e.name);let o=localStorage.getItem("oxicloud_token"),n=o?{Authorization:`Bearer ${o}`}:{},a=await fetch(`/api/files/${e.id}?inline=true`,{headers:n});if(!a.ok)throw Error(`Error fetching file: ${a.status} ${a.statusText}`);let r=await a.text();i&&i.parentNode&&i.parentNode.removeChild(i);let l=document.createElement("pre");l.className="inline-viewer-text-content",l.textContent=r,t.appendChild(l),console.log("Text viewer created successfully");}catch(e){console.error("Error creating text viewer:",e),i&&i.parentNode&&i.parentNode.removeChild(i),this.showErrorMessage(t);}}async createBlobUrlViewer(e,t,i,o){try{console.log("Creating blob URL viewer for:",e.name,"type:",t);let n=new XMLHttpRequest;n.open("GET",`/api/files/${e.id}?inline=true`,!0),n.responseType="blob";let a=localStorage.getItem("oxicloud_token");a&&n.setRequestHeader("Authorization",`Bearer ${a}`);let r=await new Promise((e,t)=>{n.onload=function(){this.status>=200&&this.status<300?e(this.response):t(Error(`Error fetching file: ${this.status} ${this.statusText}`));},n.onerror=function(){t(Error("Network error"));},n.send();}),l=URL.createObjectURL(r);if(console.log("Created blob URL:",l.substring(0,30)+"..."),o&&o.parentNode&&o.parentNode.removeChild(o),"image"===t){console.log("Creating image viewer");let t=document.createElement("img");t.className="inline-viewer-image",t.src=l,t.alt=e.name,i.appendChild(t),t.style.opacity=0,t.onload=()=>{console.log("Image loaded successfully"),t.style.opacity=1;},t.onerror=()=>{console.error("Failed to load image"),i.removeChild(t),this.showErrorMessage(i);};}else if("pdf"===t){console.log("Creating PDF viewer");let e=document.createElement("iframe");e.className="inline-viewer-pdf",e.src=l,e.setAttribute("allowfullscreen","true"),i.appendChild(e),setTimeout(()=>{if(!e.contentDocument||""===e.contentDocument.body.innerHTML){console.warn("PDF viewer might be having issues, adding fallback");let e=document.createElement("embed");e.className="inline-viewer-pdf-fallback",e.type="application/pdf",e.src=l,i.appendChild(e);}},2e3);}this.currentBlobUrl=l;}catch(e){console.error("Error creating blob URL viewer:",e),o&&o.parentNode&&o.parentNode.removeChild(o),this.showErrorMessage(i);}}showErrorMessage(e){let t=document.createElement("div");t.className="inline-viewer-message",t.innerHTML=`
      <div class="inline-viewer-icon">${u("exclamation-triangle")}</div>
      <div class="inline-viewer-text">
        <p>Error loading the file.</p>
        <p>Try downloading it directly.</p>
      </div>
    `,e.appendChild(t);}closeViewer(){document.getElementById("inline-viewer-modal").classList.remove("active"),this.currentBlobUrl&&(URL.revokeObjectURL(this.currentBlobUrl),this.currentBlobUrl=null),this.currentFile=null;}downloadFile(e){let t=localStorage.getItem("oxicloud_token"),i=t?{Authorization:`Bearer ${t}`}:{};fetch(`/api/files/${e.id}`,{headers:i}).then(e=>{if(!e.ok)throw Error(`HTTP ${e.status}`);return e.blob();}).then(t=>{let i=URL.createObjectURL(t),o=document.createElement("a");o.href=i,o.download=e.name,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i);}).catch(e=>console.error("Download error:",e));}zoomImage(e){let t=document.querySelector(".inline-viewer-container").querySelector(".inline-viewer-image");if(!t)return;let i=t.dataset.scale?parseFloat(t.dataset.scale):1;i*=e,i=Math.max(.1,Math.min(5,i)),t.dataset.scale=i,t.style.transform=`scale(${i})`;}resetZoom(){let e=document.querySelector(".inline-viewer-container").querySelector(".inline-viewer-image");e&&(e.dataset.scale=1,e.style.transform="scale(1.0)");}}function w(e){return"string"!=typeof e?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}function h(e,t="",i=""){let o=window.oxiIcon(e,t);return i?o.replace("<svg ",`<svg style="${i}" `):o;}function f(e,t=""){return window.oxiIconFromFaClass(e,t);}document.addEventListener("DOMContentLoaded",()=>{window.inlineViewer||(console.log("Initializing inline viewer on DOMContentLoaded"),window.inlineViewer=new m);}),"complete"!==document.readyState&&"interactive"!==document.readyState||window.inlineViewer||(console.log("Fallback initialization for inline viewer"),setTimeout(()=>{window.inlineViewer=new m;},100)),window.escapeHtml=w;let p={currentView:"grid",currentPath:"",currentFolder:null,contextMenuTargetFolder:null,contextMenuTargetFile:null,selectedTargetFolderId:"",moveDialogMode:"file",isTrashView:!1,isSharedView:!1,isFavoritesView:!1,isRecentView:!1,currentSection:"files",isSearchMode:!1,shareDialogItem:null,shareDialogItemType:null,notificationShareUrl:null},g={},v=null,y=null,b=!1,E={files:`
        <div class="action-buttons">
            <div class="upload-dropdown" id="upload-dropdown">
                <button class="btn btn-primary" id="upload-btn">
                    ${h("cloud-upload-alt","","margin-right: 5px;")}
                    <span data-i18n="actions.upload">Upload</span>
                    ${h("caret-down","","margin-left: 4px; font-size: 12px;")}
                </button>
                <div class="upload-dropdown-menu" id="upload-dropdown-menu">
                    <button class="upload-dropdown-item" id="upload-files-btn">
                        ${h("file")}
                        <span data-i18n="actions.upload_files">Upload files</span>
                    </button>
                    <button class="upload-dropdown-item" id="upload-folder-btn">
                        ${h("folder-open")}
                        <span data-i18n="actions.upload_folder">Upload folder</span>
                    </button>
                </div>
            </div>
            <button class="btn btn-secondary" id="new-folder-btn">
                ${h("folder-plus","","margin-right: 5px;")}
                <span data-i18n="actions.new_folder">New folder</span>
            </button>
        </div>
        <div class="view-toggle">
            <button class="toggle-btn active" id="grid-view-btn" title="Grid view">
                ${h("th")}
            </button>
            <button class="toggle-btn" id="list-view-btn" title="List view">
                ${h("list")}
            </button>
        </div>
    `,trash:`
        <div class="action-buttons">
            <button class="btn btn-danger" id="empty-trash-btn">
                ${h("trash-alt")}
                <span data-i18n="trash.empty_trash">Empty trash</span>
            </button>
        </div>
    `,favorites:`
        <div class="action-buttons"></div>
        <div class="view-toggle">
            <button class="toggle-btn active" id="grid-view-btn" title="Grid view">
                ${h("th")}
            </button>
            <button class="toggle-btn" id="list-view-btn" title="List view">
                ${h("list")}
            </button>
        </div>
    `,recent:`
        <div class="action-buttons">
            <button class="btn btn-secondary" id="clear-recent-btn">
                ${h("broom","","margin-right: 5px;")}
                <span data-i18n="actions.clear_recent">Clear recent</span>
            </button>
        </div>
        <div class="view-toggle">
            <button class="toggle-btn active" id="grid-view-btn" title="Grid view">
                ${h("th")}
            </button>
            <button class="toggle-btn" id="list-view-btn" title="List view">
                ${h("list")}
            </button>
        </div>
    `},_={search:{logicalName:"lazy-search",isReady:()=>!!window.search},favorites:{logicalName:"lazy-favorites",isReady:()=>!!window.favorites},recent:{logicalName:"lazy-recent",isReady:()=>!!window.recent},sharedView:{logicalName:"lazy-shared-view",isReady:()=>!!window.sharedView}},I=new Map,x="/dist/manifest.json",L=null;function S(){return L||(L=fetch("/dist/manifest.json",{cache:"no-store"}).then(e=>{if(!e.ok)throw Error(`Manifest fetch failed: ${e.status}`);return e.json();}).then(e=>{let t=Array.isArray(e?.chunks)?e.chunks:[],i=new Map;return t.forEach(e=>{e&&"js"===e.kind&&"string"==typeof e.logical_name&&"string"==typeof e.file&&i.set(e.logical_name,e.file);}),i;}).catch(e=>{throw Error(`Lazy manifest unavailable: ${e?.message||e}`);}));}async function F(e){if(!e)return null;if(!e.logicalName)throw Error("Lazy module configuration missing logicalName");let t=(await S()).get(e.logicalName);if(!t)throw Error(`Lazy module not found in manifest: ${e.logicalName}`);return t;}function T(e){if(I.has(e))return I.get(e);let t=document.querySelector(`script[src="${e}"]`);if(t){if("true"===t.dataset.loaded)return Promise.resolve();let i=new Promise((i,o)=>{t.addEventListener("load",()=>{t.dataset.loaded="true",i();},{once:!0}),t.addEventListener("error",()=>{o(Error(`Failed to load script: ${e}`));},{once:!0});});return I.set(e,i),i;}let i=new Promise((t,i)=>{let o=document.createElement("script");o.src=e,o.defer=!0,o.dataset.lazy="true",o.addEventListener("load",()=>{o.dataset.loaded="true",t();},{once:!0}),o.addEventListener("error",()=>{i(Error(`Failed to load script: ${e}`));},{once:!0}),document.head.appendChild(o);});return I.set(e,i),i;}async function k(e){let t=_[e];if(!t||t.isReady())return;let i=await F(t);if(await T(i),!t.isReady())throw Error(`Module loaded but not ready: ${e}`);}function $(){let e=()=>{Promise.resolve().then(()=>window.loadRecentModule()).then(()=>window.loadFavoritesModule()).catch(e=>{console.warn("Lazy warmup skipped:",e);});};"function"==typeof requestIdleCallback?requestIdleCallback(e,{timeout:2500}):setTimeout(e,1200);}function B(e,t=!1){if(!g.actionsBar)return;if("hidden"===e){g.actionsBar.style.display="none",g.actionsBar.dataset.mode="hidden";return;}if(!t&&g.actionsBar.dataset.mode===e)return;let i=E[e];i&&(g.actionsBar.innerHTML=i,g.actionsBar.style.display="flex",g.actionsBar.dataset.mode=e,g.uploadBtn=document.getElementById("upload-btn"),g.newFolderBtn=document.getElementById("new-folder-btn"),g.gridViewBtn=document.getElementById("grid-view-btn"),g.listViewBtn=document.getElementById("list-view-btn"),window.i18n&&window.i18n.translateElement&&window.i18n.translateElement(g.actionsBar),"files"===e&&A());}function C(){!b&&g.actionsBar&&(b=!0,g.actionsBar.addEventListener("click",async e=>{let t=e.target.closest("button");if(t)switch(t.id){case"upload-files-btn":{e.stopPropagation();let t=document.getElementById("upload-dropdown-menu");t&&t.classList.remove("show"),g.fileInput&&g.fileInput.click();break;}case"upload-folder-btn":{e.stopPropagation();let t=document.getElementById("upload-dropdown-menu");t&&t.classList.remove("show");let i=document.getElementById("folder-input");i&&i.click();break;}case"new-folder-btn":{let e=await window.Modal.promptNewFolder();e&&d.createFolder(e);break;}case"grid-view-btn":i.switchToGridView();break;case"list-view-btn":i.switchToListView();break;case"empty-trash-btn":await d.emptyTrash()&&P();break;case"clear-recent-btn":window.recent&&(window.recent.clearRecentFiles(),window.recent.displayRecentFiles(),window.ui.showNotification("Cleanup completed","Recent files history has been cleared"));}}));}function M(){if(N(),window.fileSharing&&window.fileSharing.init?window.fileSharing.init():console.warn("fileSharing module not fully initialized"),setTimeout(()=>{i.initializeContextMenus();},100),H(),$(),!window.inlineViewer)try{window.inlineViewer=new m;}catch(e){console.error("Error initializing inline viewer:",e);}window.multiSelect&&window.multiSelect.init&&(console.log("Initializing multi-select module"),window.multiSelect.init()),window.i18n&&window.i18n.isLoaded&&window.i18n.isLoaded()?K():(console.log("Waiting for translations to load..."),window.addEventListener("translationsLoaded",()=>{console.log("Translations loaded, proceeding with authentication"),K();}),setTimeout(()=>{window.i18n&&window.i18n.isLoaded&&window.i18n.isLoaded()||(console.warn("Translations loading timeout, proceeding with authentication anyway"),K());},3e3));}function N(){g.uploadBtn=document.getElementById("upload-btn"),g.dropzone=document.getElementById("dropzone"),g.fileInput=document.getElementById("file-input"),g.filesGrid=document.getElementById("files-grid"),g.filesListView=document.getElementById("files-list-view"),g.newFolderBtn=document.getElementById("new-folder-btn"),g.gridViewBtn=document.getElementById("grid-view-btn"),g.listViewBtn=document.getElementById("list-view-btn"),g.breadcrumb=document.querySelector(".breadcrumb"),g.pageTitle=document.querySelector(".page-title"),g.actionsBar=document.querySelector(".actions-bar"),g.navItems=document.querySelectorAll(".nav-item"),g.trashBtn=document.querySelector(".nav-item:nth-child(5)"),g.searchInput=document.querySelector(".search-container input");}function V(){let e=document.getElementById("user-menu-wrapper"),t=document.getElementById("user-avatar-btn"),i=document.getElementById("user-menu"),o=document.getElementById("user-menu-logout"),n=document.getElementById("user-menu-theme"),a=document.getElementById("user-menu-about"),r=document.getElementById("user-menu-admin"),l=document.getElementById("user-menu-admin-divider"),s=document.getElementById("user-menu-profile"),d=document.getElementById("user-menu-role-badge");if(!e||!t||!i)return;if(t.addEventListener("click",t=>{t.stopPropagation();let i=e.classList.contains("open");e.classList.toggle("open");let o=document.getElementById("notif-wrapper"),n=document.getElementById("notif-bell-btn");if(o&&o.classList.remove("open"),n&&n.classList.remove("active"),!i){D();let e="admin"===JSON.parse(localStorage.getItem("oxicloud_user")||"{}").role;r&&(r.style.display=e?"flex":"none"),l&&(l.style.display=e?"block":"none"),d&&(d.style.display=e?"block":"none");}}),document.addEventListener("click",t=>{e.classList.contains("open")&&!e.contains(t.target)&&e.classList.remove("open");}),o&&o.addEventListener("click",()=>{e.classList.remove("open"),Z();}),n){let e=document.getElementById("theme-toggle-pill");"dark"===localStorage.getItem("oxicloud_theme")&&(e&&e.classList.add("active"),document.documentElement.setAttribute("data-theme","dark")),n.addEventListener("click",t=>{if(t.stopPropagation(),e){e.classList.toggle("active");let t=e.classList.contains("active");localStorage.setItem("oxicloud_theme",t?"dark":"light"),document.documentElement.setAttribute("data-theme",t?"dark":"light"),window.ui.showNotification(t?"üåô":"‚òÄÔ∏è",t?"Dark mode enabled":"Light mode enabled");}});}r&&r.addEventListener("click",()=>{e.classList.remove("open"),window.location.href="/admin";}),s&&s.addEventListener("click",()=>{e.classList.remove("open"),window.location.href="/profile";}),a&&a.addEventListener("click",()=>{e.classList.remove("open");let t=document.getElementById("about-modal-overlay");t&&t.classList.add("show");});let c=document.getElementById("about-close-btn"),u=document.getElementById("about-modal-overlay");c&&c.addEventListener("click",()=>{u.classList.remove("show");}),u&&(u.addEventListener("click",e=>{e.target===u&&u.classList.remove("show");}),document.addEventListener("keydown",e=>{"Escape"===e.key&&u.classList.contains("show")&&u.classList.remove("show");})),R();}function D(){let e=JSON.parse(localStorage.getItem("oxicloud_user")||"{}"),t=document.getElementById("user-menu-name"),i=document.getElementById("user-menu-email"),o=document.getElementById("user-menu-avatar"),n=document.getElementById("user-menu-storage-fill"),a=document.getElementById("user-menu-storage-text");e.username&&(t&&(t.textContent=e.username),i&&(i.textContent=e.email||""),o&&(o.textContent=e.username.substring(0,2).toUpperCase()));let r=e.storage_used_bytes||0,l=e.storage_quota_bytes||0x280000000,s=l>0?Math.min(Math.round(r/l*100),100):0;if(n&&(n.style.width=s+"%"),a){let e=z(r),t=z(l);a.textContent=`${s}% \xb7 ${e} / ${t}`;}}async function R(){try{let e=await fetch("/api/version");if(e.ok){let t=await e.json(),i=document.getElementById("about-version");i&&t.version&&(i.textContent=`v${t.version}`);}}catch(e){console.warn("Could not fetch app version:",e);}}function A(){let e=document.getElementById("upload-btn"),t=document.getElementById("upload-dropdown-menu");if(!e||!t)return;y&&y.abort();let i=(y=new AbortController).signal;e.addEventListener("click",e=>{e.stopPropagation();let i=t.classList.contains("show");document.querySelectorAll(".upload-dropdown-menu.show").forEach(e=>e.classList.remove("show")),i||t.classList.add("show");},{signal:i}),v&&document.removeEventListener("click",v),v=e=>{e.target.closest("#upload-dropdown")||document.querySelectorAll(".upload-dropdown-menu.show").forEach(e=>e.classList.remove("show"));},document.addEventListener("click",v);}function H(){i.setupDragAndDrop();let e=null;g.searchInput.addEventListener("keydown",t=>{if("Enter"===t.key){e&&clearTimeout(e);let t=g.searchInput.value.trim();t?U(t):p.isSearchMode&&(p.isSearchMode=!1,p.currentPath="",i.updateBreadcrumb(""),q());}}),g.searchInput.addEventListener("input",()=>{e&&clearTimeout(e);let t=g.searchInput.value.trim();t.length>=3?e=setTimeout(()=>{U(t);},300):0===t.length&&p.isSearchMode&&(e=setTimeout(()=>{p.isSearchMode=!1,p.currentPath="",i.updateBreadcrumb(""),q();},300));}),document.getElementById("search-button").addEventListener("click",()=>{e&&clearTimeout(e);let t=g.searchInput.value.trim();t&&U(t);}),A(),C(),g.actionsBar&&(g.actionsBar.dataset.mode="files"),g.fileInput.addEventListener("change",e=>{e.target.files.length>0&&(d.uploadFiles(e.target.files),e.target.value="");});let t=document.getElementById("folder-input");t&&t.addEventListener("change",e=>{e.target.files.length>0&&(d.uploadFolderFiles(e.target.files),e.target.value="");}),g.navItems.forEach(e=>{e.addEventListener("click",()=>{if(g.navItems.forEach(e=>e.classList.remove("active")),e.classList.add("active"),"nav.shared"===e.querySelector("span").getAttribute("data-i18n"))return void G();if("nav.favorites"===e.querySelector("span").getAttribute("data-i18n"))return void W();if("nav.recent"===e.querySelector("span").getAttribute("data-i18n"))return void J();if(e===g.trashBtn){if(p.isSharedView){window.sharedView&&window.sharedView.hide(),p.isSharedView=!1;let e=document.getElementById("shared-container");e&&(e.style.display="none");}p.isTrashView=!0,p.currentSection="trash";let e=document.getElementById("files-grid"),t=document.getElementById("files-list-view");e&&(e.style.display="grid"===p.currentView?"grid":"none"),t&&(t.style.display="list"===p.currentView?"block":"none"),g.pageTitle.textContent=window.i18n?window.i18n.t("nav.trash"):"Trash",g.pageTitle.setAttribute("data-i18n","nav.trash"),B("trash"),P();}else{if(p.isSharedView){window.sharedView&&window.sharedView.hide(),p.isSharedView=!1;let e=document.getElementById("shared-container");e&&(e.style.display="none");}p.isTrashView=!1,p.currentSection="files",g.pageTitle.textContent=window.i18n?window.i18n.t("nav.files"):"Files",B("files");let e=document.getElementById("files-grid"),t=document.getElementById("files-list-view");e&&(e.style.display="grid"===p.currentView?"grid":"none"),t&&(t.style.display="list"===p.currentView?"block":"none"),p.currentPath="",i.updateBreadcrumb(""),q();}});}),"list"===localStorage.getItem("oxicloud-view")&&i.switchToListView(),V(),document.addEventListener("click",e=>{let t=document.getElementById("folder-context-menu"),o=document.getElementById("file-context-menu");t&&"block"===t.style.display&&!t.contains(e.target)&&i.closeContextMenu(),o&&"block"===o.style.display&&!o.contains(e.target)&&i.closeFileContextMenu(),e.target.closest(".file-card")||e.target.closest(".file-item")||e.target.closest(".context-menu")||e.target.closest(".about-modal")||e.target.closest(".batch-action-bar")||e.target.closest(".list-header.selection-mode")||(document.querySelectorAll(".file-card.selected").forEach(e=>e.classList.remove("selected")),document.querySelectorAll(".file-item.selected").forEach(e=>e.classList.remove("selected")));});}async function q(e={}){try{let t;console.log("Starting loadFiles() - loading files...",e);let o=e.forceRefresh||!1;if(window.isLoadingFiles)return void console.log("A file load is already in progress, ignoring request");window.isLoadingFiles=!0,g.filesGrid.innerHTML=`
            <div class="files-loading-spinner">
                <div class="spinner"></div>
                <span>${window.i18n?window.i18n.t("files.loading"):"Loading files‚Ä¶"}</span>
            </div>
        `,p.userHomeFolderId||await Y();let n=new Date().getTime();p.currentPath&&""!==p.currentPath?(t=`/api/folders/${p.currentPath}/listing?t=${n}`,console.log(`Loading subfolder content: ${p.currentPath}`)):p.userHomeFolderId?(t=`/api/folders/${p.userHomeFolderId}/listing?t=${n}`,p.currentPath=p.userHomeFolderId,i.updateBreadcrumb(p.userHomeFolderName||"Home"),console.log(`Loading user folder: ${p.userHomeFolderName} (${p.userHomeFolderId})`)):(t=`/api/folders?t=${n}`,console.warn("Emergency fallback to root folder - this should not normally happen"));let a=localStorage.getItem("oxicloud_token"),r={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache"};a&&(r.Authorization=`Bearer ${a}`);let l={headers:r,cache:"no-store"};o&&(t+="&force_refresh=true",l.headers["X-Force-Refresh"]="true",console.log("Forcing complete refresh ignoring cache")),console.log(`Loading listing from ${t}`);let s=await fetch(t,l);if(401===s.status||403===s.status){console.warn("Auth error when loading files, showing empty list"),g.filesGrid.innerHTML='<div class="empty-state"><p>Could not load files</p></div>',g.filesListView.innerHTML=`
                <div class="list-header">
                    <div class="list-header-checkbox"><input type="checkbox" id="select-all-checkbox" title="Select all"></div>
                    <div>Name</div>
                    <div>Type</div>
                    <div>Size</div>
                    <div>Modified</div>
                </div>
            `;return;}if(!s.ok)throw Error(`Server responded with status: ${s.status}`);let d=await s.json();window.multiSelect&&window.multiSelect.clear(),i._items.clear(),g.filesGrid.innerHTML="";let c=window.i18n&&window.i18n.t?window.i18n.t:e=>e.split(".").pop();g.filesListView.innerHTML=`
            <div class="list-header">
                <div class="list-header-checkbox"><input type="checkbox" id="select-all-checkbox" title="Select all"></div>
                <div data-i18n="files.name">${c("files.name")}</div>
                <div data-i18n="files.type">${c("files.type")}</div>
                <div data-i18n="files.size">${c("files.size")}</div>
                <div data-i18n="files.modified">${c("files.modified")}</div>
            </div>
        `;let u=document.getElementById("select-all-checkbox");u&&window.multiSelect&&u.addEventListener("change",()=>window.multiSelect.toggleAll());let m=Array.isArray(d.folders)?d.folders:[],w=Array.isArray(d.files)?d.files:[];i.renderFolders(m),i.renderFiles(w),console.log(`Loaded ${m.length} folders and ${w.length} files`);}catch(e){console.error("Error loading folders:",e),i.showNotification("Error","Could not load files and folders");}finally{window.isLoadingFiles=!1;}}function z(e){if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][t];}async function P(){try{window.multiSelect&&window.multiSelect.clear(),g.filesGrid.innerHTML="";let e=window.i18n&&window.i18n.t?window.i18n.t:e=>e.split(".").pop();g.filesListView.innerHTML=`
            <div class="list-header trash-header">
                <div data-i18n="files.name">${e("files.name")}</div>
                <div data-i18n="files.type">${e("files.type")}</div>
                <div data-i18n="trash.original_location">${e("trash.original_location")}</div>
                <div data-i18n="trash.deleted_date">${e("trash.deleted_date")}</div>
                <div data-i18n="trash.actions">${e("trash.actions")}</div>
            </div>
        `,i.updateBreadcrumb("");let t=await d.getTrashItems();if(0===t.length){let e=document.createElement("div");e.className="empty-state",e.innerHTML=`
                ${h("trash","","font-size: 48px; color: #ddd; margin-bottom: 16px;")}
                <p>${window.i18n?window.i18n.t("trash.empty_state"):"The trash is empty"}</p>
            `,g.filesGrid.appendChild(e);return;}t.forEach(e=>{O(e);});}catch(e){console.error("Error loading trash items:",e),window.ui.showNotification("Error","Error loading trash items");}}function O(e){let t,i,o="file"===e.item_type,n=window.formatDateTime(e.trashed_at);if(o){t=e.icon_class||(window.ui&&window.ui.getIconClass?window.ui.getIconClass(e.name):"file");let o=e.category||"";i=o?window.i18n&&window.i18n.t(`files.file_types.${o.toLowerCase()}`)||o:window.i18n?window.i18n.t("files.file_types.document"):"Document";}else t=e.icon_class||"folder",i=window.i18n?window.i18n.t("files.file_types.folder"):"Folder";let a=String(t).includes("fa-")?f(t):h(t),r=document.createElement("div");r.className="file-card trash-item",r.dataset.trashId=e.id,r.dataset.originalId=e.original_id,r.dataset.itemType=e.item_type,r.innerHTML=`
        <div class="file-icon">
            ${a}
        </div>
        <div class="file-name">${w(e.name)}</div>
        <div class="file-info">${w(i)} - ${w(n)}</div>
        <div class="trash-actions">
            <button class="btn-restore" title="${window.i18n?window.i18n.t("trash.restore"):"Restore"}">
                ${h("undo")}
            </button>
            <button class="btn-delete" title="${window.i18n?window.i18n.t("trash.delete_permanently"):"Delete permanently"}">
                ${h("trash")}
            </button>
        </div>
    `,r.querySelector(".btn-restore").addEventListener("click",async t=>{t.stopPropagation(),await d.restoreFromTrash(e.id)&&P();}),r.querySelector(".btn-delete").addEventListener("click",async t=>{t.stopPropagation(),await d.deletePermanently(e.id)&&P();}),g.filesGrid.appendChild(r);let l=document.createElement("div");l.className="file-item trash-item",l.dataset.trashId=e.id,l.dataset.originalId=e.original_id,l.dataset.itemType=e.item_type,l.innerHTML=`
        <div class="name-cell">
            <div class="file-icon">
                ${f(t)}
            </div>
            <span>${w(e.name)}</span>
        </div>
        <div class="type-cell">${w(i)}</div>
        <div class="path-cell">${w(e.original_path||"--")}</div>
        <div class="date-cell">${w(n)}</div>
        <div class="actions-cell">
            <button class="btn-restore" title="${window.i18n?window.i18n.t("trash.restore"):"Restore"}">
                ${h("undo")}
            </button>
            <button class="btn-delete" title="${window.i18n?window.i18n.t("trash.delete_permanently"):"Delete permanently"}">
                ${h("trash")}
            </button>
        </div>
    `,l.querySelector(".btn-restore").addEventListener("click",async t=>{t.stopPropagation(),await d.restoreFromTrash(e.id)&&P();}),l.querySelector(".btn-delete").addEventListener("click",async t=>{t.stopPropagation(),await d.deletePermanently(e.id)&&P();}),g.filesListView.appendChild(l);}async function U(e,t){console.log(`Performing search for: "${e}" (sort: ${t||"relevance"})`);try{p.isSearchMode=!0,i.updateBreadcrumb(`Search: "${e}"`);let o=document.getElementById("files-grid");o&&(o.innerHTML=`
                <div class="search-results-header">
                    <h3>${h("spinner","oxi-icon-spin")} Searching for "${e}"...</h3>
                </div>
            `);let n={recursive:!0,limit:100,sort_by:t||"relevance"};!p.isTrashView&&(n.folder_id=p.currentPath,n.folder_id&&""!==n.folder_id||(await Y(),n.folder_id=p.currentPath)),await window.loadSearchModule();let a=await window.search.searchFiles(e,n);window.search.displaySearchResults(a);}catch(e){console.error("Search error:",e),window.ui.showNotification("Error","Error performing search");}}function G(){window.loadSharedViewModule().then(()=>{p.isTrashView=!1,p.isSharedView=!0,p.currentSection="shared",g.navItems.forEach(e=>e.classList.remove("active"));let e=document.querySelector(".nav-item:nth-child(2)");e&&e.classList.add("active"),g.pageTitle.textContent=window.i18n?window.i18n.t("nav.shared"):"Shared",g.pageTitle.setAttribute("data-i18n","nav.shared"),i.updateBreadcrumb("");let t=document.querySelector(".breadcrumb");t&&(t.style.display="none"),g.actionsBar&&(g.actionsBar.style.display="none");let o=document.getElementById("files-grid"),n=document.getElementById("files-list-view");o&&(o.style.display="none"),n&&(n.style.display="none"),window.sharedView&&(window.sharedView.init(),window.sharedView.show());}).catch(e=>{console.error("Error loading shared view module:",e),window.ui&&window.ui.showNotification&&window.ui.showNotification("Error","Could not load shared view");});}function j(){p.isTrashView=!1,p.isTrashView=!1,p.isSharedView=!1,p.isFavoritesView=!1,p.isRecentView=!1,p.currentSection="files",g.pageTitle.textContent=window.i18n?window.i18n.t("nav.files"):"Files",g.pageTitle.setAttribute("data-i18n","nav.files");let e=document.querySelector(".breadcrumb");e&&(e.style.display=""),g.navItems.forEach(e=>e.classList.remove("active"));let t=document.querySelector(".nav-item:first-child");t&&t.classList.add("active"),B("files"),window.sharedView&&window.sharedView.hide();let o=document.getElementById("files-grid");o&&(o.style.display="grid"===p.currentView?"grid":"none");let n=document.getElementById("files-list-view");n&&(n.style.display="list"===p.currentView?"block":"none"),p.userHomeFolderId?(p.currentPath=p.userHomeFolderId,i.updateBreadcrumb(p.userHomeFolderName||"Home")):p.currentPath="",q();}async function W(){try{await window.loadFavoritesModule();}catch(e){console.error("Error loading favorites module:",e),window.ui&&window.ui.showNotification&&window.ui.showNotification("Error","Could not load favorites");return;}p.isTrashView=!1,p.isSharedView=!1,p.isFavoritesView=!0,p.currentSection="favorites",g.navItems.forEach(e=>e.classList.remove("active"));let e=document.querySelector(".nav-item:nth-child(4)");e&&e.classList.add("active"),g.pageTitle.textContent=window.i18n?window.i18n.t("nav.favorites"):"Favorites",g.pageTitle.setAttribute("data-i18n","nav.favorites"),i.updateBreadcrumb(""),window.sharedView&&window.sharedView.hide(),B("favorites");let t=document.getElementById("files-grid"),o=document.getElementById("files-list-view");if(t&&(t.style.display="grid"===p.currentView?"grid":"none"),o&&(o.style.display="list"===p.currentView?"block":"none"),window.favorites)window.favorites.displayFavorites();else{console.error("Favorites module not loaded or initialized");let e=document.getElementById("files-grid");e&&(e.innerHTML=`
                <div class="empty-state">
                    ${h("exclamation-circle","","font-size: 48px; color: #f44336; margin-bottom: 16px;")}
                    <p>Error loading the favorites module</p>
                </div>
            `);}}async function J(){try{await window.loadRecentModule();}catch(e){console.error("Error loading recent module:",e),window.ui&&window.ui.showNotification&&window.ui.showNotification("Error","Could not load recent files");return;}p.isTrashView=!1,p.isSharedView=!1,p.isFavoritesView=!1,p.isRecentView=!0,p.currentSection="recent",g.navItems.forEach(e=>e.classList.remove("active"));let e=document.querySelector(".nav-item:nth-child(3)");e&&e.classList.add("active"),g.pageTitle.textContent=window.i18n?window.i18n.t("nav.recent"):"Recent",g.pageTitle.setAttribute("data-i18n","nav.recent"),i.updateBreadcrumb(""),window.sharedView&&window.sharedView.hide(),B("recent");let t=document.getElementById("files-grid"),o=document.getElementById("files-list-view");if(t&&(t.style.display="grid"===p.currentView?"grid":"none"),o&&(o.style.display="list"===p.currentView?"block":"none"),window.recent)window.recent.displayRecentFiles();else{console.error("Recent files module not loaded or initialized");let e=document.getElementById("files-grid");e&&(e.innerHTML=`
                <div class="empty-state">
                    ${h("exclamation-circle","","font-size: 48px; color: #f44336; margin-bottom: 16px;")}
                    <p>Error loading the recent files module</p>
                </div>
            `);}}async function X(){let e=localStorage.getItem("oxicloud_token");if(console.log("refreshUserData called, token:",e?e.substring(0,20)+"...":"null"),!e)return console.log("No valid token, skipping user data refresh"),null;try{console.log("Fetching /api/auth/me...");let t=await fetch("/api/auth/me",{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(console.log("/api/auth/me response status:",t.status),!t.ok)return console.warn("Failed to fetch user data:",t.status),null;let i=await t.json();return console.log("Refreshed user data from server:",i),console.log("Storage from server: used=",i.storage_used_bytes,"quota=",i.storage_quota_bytes),localStorage.setItem("oxicloud_user",JSON.stringify(i)),Q(i),i;}catch(e){return console.error("Error refreshing user data:",e),null;}}async function K(){try{let e="oxicloud_token",t="oxicloud_refresh_token",i="oxicloud_token_expiry",o="oxicloud_user",n=new URLSearchParams(window.location.search).get("oidc_code");if(n){console.log("OIDC exchange code detected, exchanging for tokens...");try{let a=await fetch("/api/auth/oidc/exchange",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:n})});if(!a.ok){let e=await a.text();console.error("OIDC token exchange failed:",a.status,e),window.location.href="/login?source=oidc_error";return;}let r=await a.json();console.log("OIDC token exchange successful");let l=r.access_token||r.token,s=r.refresh_token||r.refreshToken;if(l){localStorage.setItem(e,l),s&&localStorage.setItem(t,s);let n=!1,a=l.split(".");if(3===a.length)try{let e=JSON.parse(atob(a[1]));if(e.exp){let t=new Date(1e3*e.exp);isNaN(t.getTime())||(localStorage.setItem(i,t.toISOString()),n=!0);}}catch(e){console.error("Error parsing JWT:",e);}if(!n){let e=new Date;e.setDate(e.getDate()+30),localStorage.setItem(i,e.toISOString());}r.user&&localStorage.setItem(o,JSON.stringify(r.user)),window.history.replaceState({},document.title,"/"),window.location.reload();return;}}catch(e){console.error("OIDC exchange error:",e),window.location.href="/login?source=oidc_error";return;}}if(!localStorage.getItem(e)){console.log("No token found, redirecting to login"),window.location.href="/login?source=app";return;}console.log("Token found, proceeding with app initialization");let a=JSON.parse(localStorage.getItem(o)||"{}");if(a.username){let e=a.username.substring(0,2).toUpperCase();document.querySelectorAll(".user-avatar, .user-menu-avatar").forEach(t=>{t.textContent=e;});let t=document.getElementById("user-menu-name"),i=document.getElementById("user-menu-email");t&&(t.textContent=a.username),i&&(i.textContent=a.email||""),Q(a),X().then(e=>{e&&console.log("Storage usage updated from server");}).catch(e=>{console.warn("Could not refresh user data:",e);}),Y().then(()=>q());}else{console.log("No user data, attempting to fetch from server");try{let n=await X();if(n&&n.username){let e=n.username.substring(0,2).toUpperCase();document.querySelectorAll(".user-avatar, .user-menu-avatar").forEach(t=>t.textContent=e),Q(n),Y().then(()=>q());}else console.warn("Could not retrieve user data, redirecting to login"),localStorage.removeItem(e),localStorage.removeItem(t),localStorage.removeItem(i),localStorage.removeItem(o),window.location.href="/login?source=invalid_session";}catch(n){console.error("Failed to fetch user data:",n),localStorage.removeItem(e),localStorage.removeItem(t),localStorage.removeItem(i),localStorage.removeItem(o),window.location.href="/login?source=session_error";}}}catch(e){console.error("Error during authentication check:",e),localStorage.removeItem("oxicloud_token"),localStorage.removeItem("oxicloud_refresh_token"),localStorage.removeItem("oxicloud_token_expiry"),localStorage.removeItem("oxicloud_user"),window.location.href="/login?source=auth_error";}}async function Y(){if(!p.userHomeFolderId)try{let e=localStorage.getItem("oxicloud_token"),t=e?{Authorization:`Bearer ${e}`}:{},o=await fetch("/api/folders",{headers:t});if(!o.ok)return void console.warn(`Could not fetch home folder: ${o.status}`);let n=await o.json(),a=Array.isArray(n)?n:[];if(a.length>0){let e=a[0];p.userHomeFolderId=e.id,p.userHomeFolderName=e.name,p.currentPath=e.id,i.updateBreadcrumb(e.name),console.log(`Home folder resolved: ${e.name} (${e.id})`);}else console.warn("No root folders found for user"),p.currentPath="",i.updateBreadcrumb("");}catch(e){console.error("Error resolving home folder:",e),p.currentPath="",i.updateBreadcrumb("");}}function Z(){localStorage.removeItem("oxicloud_token"),localStorage.removeItem("oxicloud_refresh_token"),localStorage.removeItem("oxicloud_token_expiry"),localStorage.removeItem("oxicloud_user"),sessionStorage.removeItem("redirect_count"),window.location.href="/login";}function Q(e){let t=0,i=0x280000000,o=0;e&&(t=e.storage_used_bytes||0,(i=e.storage_quota_bytes||0x280000000)>0&&(o=Math.min(Math.round(t/i*100),100)));let n=z(t),a=z(i),r=document.querySelector(".storage-fill"),l=document.querySelector(".storage-info");r&&(r.style.width=`${o}%`),l&&(l.removeAttribute("data-i18n"),window.i18n&&window.i18n.t?l.textContent=window.i18n.t("storage.used",{percentage:o,used:n,total:a}):l.textContent=`${o}% used (${n} / ${a})`),console.log(`Updated storage display: ${o}% (${n} / ${a})`);}window.loadSearchModule=async function(){await k("search");},window.loadSharedViewModule=async function(){await k("sharedView");},window.loadFavoritesModule=async function(){await k("favorites"),window.favorites&&window.favorites.init&&!window.favorites.__initialized&&(await window.favorites.init(),window.favorites.__initialized=!0);},window.loadRecentModule=async function(){await k("recent"),window.recent&&window.recent.init&&!window.recent.__initialized&&(window.recent.init(),window.recent.__initialized=!0);},document.addEventListener("search-resort",e=>{let t=document.querySelector(".search-container input");t&&t.value.trim()&&U(t.value.trim(),e.detail.sort_by);}),window.app=p,window.loadFiles=q,window.loadTrashItems=P,window.formatFileSize=z,window.performSearch=U,window.formatDateTime=function(e){let t;return e?isNaN((t=e instanceof Date?e:new Date("number"==typeof e?e<1e12?1e3*e:e:e)).getTime())?String(e):t.toLocaleDateString()+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"";},window.formatDateShort=function(e){if(!e)return"N/A";let t=new Date("number"==typeof e?1e3*e:e);return isNaN(t.getTime())?String(e):t.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});},window.isTextViewable=function(e){return!!e&&(!!e.startsWith("text/")||["application/json","application/xml","application/javascript","application/x-sh","application/x-yaml","application/toml","application/x-toml","application/sql"].includes(e));},window.selectFolder=(e,t)=>{p.currentPath=e,i.updateBreadcrumb(t),q();},window.switchToFilesView=j,window.switchToSharedView=G,window.switchToFavoritesView=W,window.switchToRecentFilesView=J,window.refreshUserData=X,document.addEventListener("DOMContentLoaded",M);