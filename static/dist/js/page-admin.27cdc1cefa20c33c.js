let e="/api",t=localStorage.getItem("oxicloud_token")||localStorage.getItem("token")||localStorage.getItem("access_token"),n="",a=0,s=50,o=0;function d(){return{Authorization:"Bearer "+t,"Content-Type":"application/json"};}function l(e){if(0===e)return"0 B";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB","TB"][t];}function r(e){if(!e)return"Never";let t=new Date(e),n=Math.floor((new Date-t)/1e3);return n<60?"Just now":n<3600?Math.floor(n/60)+"m ago":n<86400?Math.floor(n/3600)+"h ago":n<2592e3?Math.floor(n/86400)+"d ago":t.toLocaleDateString();}function i(e,t){document.querySelectorAll(".admin-tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.getElementById("tab-"+e).classList.add("active"),t&&t.classList.add("active"),"users"===e&&u(),"dashboard"===e&&c();}async function c(){try{let t=await fetch(e+"/admin/dashboard",{headers:d()});if(!t.ok)return;let n=await t.json();document.getElementById("ds-total-users").textContent=n.total_users,document.getElementById("ds-active-users").textContent=n.active_users,document.getElementById("ds-admin-users").textContent=n.admin_users,document.getElementById("ds-version").textContent="v"+n.server_version,document.getElementById("ds-used").textContent=l(n.total_used_bytes),document.getElementById("ds-quota").textContent=l(n.total_quota_bytes),document.getElementById("ds-usage-pct").textContent=n.storage_usage_percent.toFixed(1)+"%";let a=document.getElementById("ds-bar");a.style.width=Math.min(n.storage_usage_percent,100)+"%",a.className="progress-fill "+(n.storage_usage_percent>90?"red":n.storage_usage_percent>70?"orange":"green"),document.getElementById("ds-auth").textContent=n.auth_enabled?"Enabled":"Disabled",document.getElementById("ds-oidc").textContent=n.oidc_configured?"Active":"Off",document.getElementById("ds-quotas-flag").textContent=n.quotas_enabled?"Enabled":"Disabled",void 0!==n.registration_enabled&&(document.getElementById("ds-registration").checked=n.registration_enabled,document.getElementById("registration-warning").style.display=n.registration_enabled?"none":"flex"),n.users_over_80_percent>0&&(document.getElementById("ds-warn-card").style.display="",document.getElementById("ds-over80").textContent=n.users_over_80_percent),n.users_over_quota>0&&(document.getElementById("ds-danger-card").style.display="",document.getElementById("ds-overquota").textContent=n.users_over_quota);}catch(e){console.error("Dashboard error",e);}}async function u(){let t=document.getElementById("users-tbody");t.innerHTML='<tr><td colspan="6" style="text-align:center;padding:28px;color:#94a3b8"><i class="fas fa-spinner fa-spin"></i> Loading…</td></tr>';try{let s=await fetch(e+"/admin/users?limit=50&offset="+50*a,{headers:d()});if(!s.ok){t.innerHTML='<tr><td colspan="6" style="color:#991b1b;padding:20px"><i class="fas fa-exclamation-circle"></i> Failed to load users</td></tr>';return;}let i=await s.json();o=i.total;let c=i.users;if(0===c.length){t.innerHTML='<tr><td colspan="6" style="text-align:center;padding:28px;color:#94a3b8">No users found</td></tr>';return;}t.innerHTML=c.map(e=>{let t=e.storage_quota_bytes>0?e.storage_used_bytes/e.storage_quota_bytes*100:0,a=e.storage_quota_bytes>0?l(e.storage_used_bytes)+" / "+l(e.storage_quota_bytes):l(e.storage_used_bytes)+" / ∞",s=e.id===n;return'<tr><td><div class="user-info"><span class="user-name">'+e.username+(s?' <span style="color:#94a3b8;font-weight:400">(you)</span>':"")+'</span><span class="user-email">'+e.email+'</span></div></td><td><span class="badge badge-'+e.role+'">'+("admin"===e.role?'<i class="fas fa-shield-alt" style="font-size:10px"></i> ':"")+e.role+'</span></td><td><span class="badge badge-'+(e.active?"active":"inactive")+'">'+(e.active?"Active":"Inactive")+'</span></td><td><div class="quota-bar"><div class="progress-bar" style="width:80px"><div class="progress-fill '+(t>90?"red":t>70?"orange":"green")+'" style="width:'+Math.min(t,100)+'%"></div></div><span class="quota-text">'+a+'</span></div></td><td style="font-size:12px;color:#94a3b8">'+r(e.last_login_at)+'</td><td><div class="actions-row"><button class="btn btn-sm btn-secondary" onclick="openQuotaModal(\''+e.id+"','"+e.username+"',"+e.storage_quota_bytes+')" title="Edit quota"><i class="fas fa-box"></i></button><button class="btn btn-sm btn-secondary" onclick="openResetPasswordModal(\''+e.id+"','"+e.username+'\')" title="Reset password"><i class="fas fa-key"></i></button><button class="btn btn-sm btn-secondary" onclick="toggleRole(\''+e.id+"','"+e.role+'\')" title="Toggle role"'+(s?" disabled":"")+'><i class="fas fa-'+("admin"===e.role?"user":"crown")+'"></i></button><button class="btn btn-sm '+(e.active?"btn-danger":"btn-success")+'" onclick="toggleActive(\''+e.id+"',"+e.active+')" title="'+(e.active?"Deactivate":"Activate")+'"'+(s&&e.active?" disabled":"")+'><i class="fas fa-'+(e.active?"ban":"check")+'"></i></button><button class="btn btn-sm btn-danger" onclick="deleteUser(\''+e.id+"','"+e.username+'\')" title="Delete"'+(s?" disabled":"")+'><i class="fas fa-trash-alt"></i></button></div></td></tr>';}).join(""),document.getElementById("users-info").textContent="Showing "+(50*a+1)+"-"+Math.min((a+1)*50,o)+" of "+o,document.getElementById("prev-btn").disabled=0===a,document.getElementById("next-btn").disabled=(a+1)*50>=o;}catch(e){t.innerHTML='<tr><td colspan="6" style="color:#991b1b;padding:20px"><i class="fas fa-exclamation-circle"></i> Error: '+e.message+"</td></tr>";}}function m(){a>0&&(a--,u());}function g(){(a+1)*50<o&&(a++,u());}async function y(t,n){let a="admin"===n?"user":"admin";if(confirm("Change role to "+a+"?"))try{let n=await fetch(e+"/admin/users/"+t+"/role",{method:"PUT",headers:d(),body:JSON.stringify({role:a})});if(n.ok)u();else{let e=await n.json();alert(e.message||"Failed");}}catch(e){alert("Error: "+e.message);}}async function f(t,n){if(confirm("Are you sure you want to "+(n?"deactivate":"activate")+" this user?"))try{let a=await fetch(e+"/admin/users/"+t+"/active",{method:"PUT",headers:d(),body:JSON.stringify({active:!n})});if(a.ok)u();else{let e=await a.json();alert(e.message||"Failed");}}catch(e){alert("Error: "+e.message);}}async function p(t,n){if(confirm('DELETE user "'+n+'"? This cannot be undone!'))try{let n=await fetch(e+"/admin/users/"+t,{method:"DELETE",headers:d()});if(n.ok)u(),c();else{let e=await n.json();alert(e.message||"Failed");}}catch(e){alert("Error: "+e.message);}}let b="";function v(e,t,n){b=e,document.getElementById("qm-username").textContent=t;let a=n/0x40000000;document.getElementById("qm-unit").value="1073741824",document.getElementById("qm-value").value=a>0?Math.round(10*a)/10:0,document.getElementById("quota-modal").style.display="flex";}function E(){document.getElementById("quota-modal").style.display="none";}async function h(){let t=Math.round((parseFloat(document.getElementById("qm-value").value)||0)*parseInt(document.getElementById("qm-unit").value));try{let n=await fetch(e+"/admin/users/"+b+"/quota",{method:"PUT",headers:d(),body:JSON.stringify({quota_bytes:t})});if(n.ok)E(),u(),c();else{let e=await n.json();alert(e.message||"Failed");}}catch(e){alert("Error: "+e.message);}}function I(){document.getElementById("cu-username").value="",document.getElementById("cu-password").value="",document.getElementById("cu-email").value="",document.getElementById("cu-role").value="user",document.getElementById("cu-quota-value").value="1",document.getElementById("cu-quota-unit").value="1073741824",document.getElementById("cu-error").className="alert",document.getElementById("cu-error").textContent="",document.getElementById("create-user-modal").style.display="flex",setTimeout(()=>document.getElementById("cu-username").focus(),100);}function B(){document.getElementById("create-user-modal").style.display="none";}async function _(){let t=document.getElementById("cu-username").value.trim(),n=document.getElementById("cu-password").value,a=document.getElementById("cu-email").value.trim()||null,s=document.getElementById("cu-role").value,o=Math.round((parseFloat(document.getElementById("cu-quota-value").value)||0)*parseInt(document.getElementById("cu-quota-unit").value)),l=document.getElementById("cu-error");if(t.length<3){l.textContent="Username must be at least 3 characters",l.className="alert alert-error";return;}if(n.length<8){l.textContent="Password must be at least 8 characters",l.className="alert alert-error";return;}let r=document.getElementById("cu-submit");r.disabled=!0,r.innerHTML='<i class="fas fa-spinner fa-spin"></i> Creating…';try{let r=await fetch(e+"/admin/users",{method:"POST",headers:d(),body:JSON.stringify({username:t,password:n,email:a,role:s,quota_bytes:o})});r.ok?(B(),u(),c()):(l.textContent=(await r.json().catch(()=>({}))).message||"Failed to create user",l.className="alert alert-error");}catch(e){l.textContent="Network error: "+e.message,l.className="alert alert-error";}r.disabled=!1,r.innerHTML='<i class="fas fa-user-plus"></i> Create';}let w="";function x(e,t){w=e,document.getElementById("rp-username").textContent=t,document.getElementById("rp-password").value="",document.getElementById("rp-error").className="alert",document.getElementById("rp-error").textContent="",document.getElementById("reset-pw-modal").style.display="flex",setTimeout(()=>document.getElementById("rp-password").focus(),100);}function k(){document.getElementById("reset-pw-modal").style.display="none";}async function T(){let t=document.getElementById("rp-password").value,n=document.getElementById("rp-error");if(t.length<8){n.textContent="Password must be at least 8 characters",n.className="alert alert-error";return;}let a=document.getElementById("rp-submit");a.disabled=!0,a.innerHTML='<i class="fas fa-spinner fa-spin"></i> Resetting…';try{let a=await fetch(e+"/admin/users/"+w+"/password",{method:"PUT",headers:d(),body:JSON.stringify({new_password:t})});a.ok?k():(n.textContent=(await a.json().catch(()=>({}))).message||"Failed",n.className="alert alert-error");}catch(e){n.textContent="Error: "+e.message,n.className="alert alert-error";}a.disabled=!1,a.innerHTML='<i class="fas fa-save"></i> Reset';}async function M(t){document.getElementById("registration-warning").style.display=t?"none":"flex";try{let n=await fetch(e+"/admin/settings/registration",{method:"PUT",headers:d(),body:JSON.stringify({registration_enabled:t})});if(!n.ok){document.getElementById("ds-registration").checked=!t,document.getElementById("registration-warning").style.display=t?"none":"flex";let e=await n.json().catch(()=>({}));alert(e.message||"Failed to update registration setting");}}catch(e){document.getElementById("ds-registration").checked=!t,document.getElementById("registration-warning").style.display=t?"none":"flex",alert("Error: "+e.message);}}function C(e,t){let n=document.getElementById("oidc-status");n.textContent=e,n.className="alert alert-"+t;}function q(){let e=document.getElementById("callback-url").textContent;navigator.clipboard.writeText(e);}async function L(){let t=document.getElementById("issuer-url").value.trim();if(!t)return void C("Enter an Issuer URL first","error");let n=document.getElementById("discover-btn");n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Discovering…';let a=document.getElementById("discovery-result");try{let n=await fetch(e+"/admin/settings/oidc/test",{method:"POST",headers:d(),body:JSON.stringify({issuer_url:t})}),s=await n.json();s.success?(a.innerHTML='<div class="discovery-result ok"><strong><i class="fas fa-check-circle"></i> '+s.message+"</strong><dl><dt>Issuer</dt><dd>"+(s.issuer||"—")+"</dd><dt>Auth Endpoint</dt><dd>"+(s.authorization_endpoint||"—")+"</dd></dl></div>",!document.getElementById("provider-name").value&&s.provider_name_suggestion&&(document.getElementById("provider-name").value=s.provider_name_suggestion)):a.innerHTML='<div class="discovery-result fail"><strong><i class="fas fa-times-circle"></i> '+s.message+"</strong></div>";}catch(e){a.innerHTML='<div class="discovery-result fail"><i class="fas fa-times-circle"></i> Error: '+e.message+"</div>";}n.disabled=!1,n.innerHTML='<i class="fas fa-search"></i> Auto-discover';}async function N(){let t=document.getElementById("save-btn");t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving…';let n={enabled:document.getElementById("oidc-enabled").checked,issuer_url:document.getElementById("issuer-url").value.trim(),client_id:document.getElementById("client-id").value.trim(),client_secret:document.getElementById("client-secret").value||null,scopes:document.getElementById("scopes").value.trim()||null,auto_provision:document.getElementById("auto-provision").checked,admin_groups:document.getElementById("admin-groups").value.trim()||null,disable_password_login:document.getElementById("disable-password").checked,provider_name:document.getElementById("provider-name").value.trim()||null};try{let t=await fetch(e+"/admin/settings/oidc",{method:"PUT",headers:d(),body:JSON.stringify(n)});if(t.ok)C("Settings saved — OIDC is now "+(n.enabled?"active":"disabled"),"success"),c();else{let e=await t.json().catch(()=>({}));C("Error: "+(e.message||t.statusText),"error");}}catch(e){C("Network error: "+e.message,"error");}t.disabled=!1,t.innerHTML='<i class="fas fa-save"></i> Save';}async function S(){if(!t)return void H();try{let t=await fetch(e+"/auth/me",{headers:d()});if(!t.ok)return void H();let a=await t.json();if("admin"!==a.role)return void H();n=a.id;let s=await fetch(e+"/admin/settings/oidc",{headers:d()});if(s.ok){let e=await s.json();document.getElementById("oidc-enabled").checked=e.enabled,document.getElementById("oidc-form").style.display=e.enabled?"block":"none",document.getElementById("provider-name").value=e.provider_name||"",document.getElementById("issuer-url").value=e.issuer_url||"",document.getElementById("client-id").value=e.client_id||"",document.getElementById("scopes").value=e.scopes||"openid profile email",document.getElementById("auto-provision").checked=e.auto_provision,document.getElementById("admin-groups").value=e.admin_groups||"",document.getElementById("disable-password").checked=e.disable_password_login,document.getElementById("password-warning").style.display=e.disable_password_login?"flex":"none",document.getElementById("callback-url").textContent=e.callback_url,e.client_secret_set&&(document.getElementById("secret-hint").style.display="block"),(e.env_overrides||[]).forEach(e=>{let t=document.getElementById("badge-"+e);t&&(t.innerHTML='<span class="badge badge-env">ENV</span>');});}await c(),document.getElementById("loading").style.display="none",document.getElementById("main-content").style.display="block";}catch(e){console.error(e),H();}}function H(){document.getElementById("loading").style.display="none",document.getElementById("access-denied").style.display="block";}document.getElementById("oidc-enabled").addEventListener("change",function(){document.getElementById("oidc-form").style.display=this.checked?"block":"none";}),document.getElementById("disable-password").addEventListener("change",function(){document.getElementById("password-warning").style.display=this.checked?"flex":"none";}),S();