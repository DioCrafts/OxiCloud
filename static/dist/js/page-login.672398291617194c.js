let e,t,o,n,a,r,l,i,s,c,d;let g="/api/auth",m=`${g}/login`,u=`${g}/register`,p=`${g}/me`,y=`${g}/refresh`,f="oxicloud_token",h="oxicloud_refresh_token",w="oxicloud_token_expiry",v="oxicloud_user",I="oxicloud-locale",k="oxicloud_first_run_completed",E={en:{title:"Welcome to OxiCloud",subtitle:"Please select your language",continue:"Continue",autodetected:"We detected your language",moreLanguages:"More languages...",modalTitle:"Select language",searchPlaceholder:"Search language..."},es:{title:"Bienvenido a OxiCloud",subtitle:"Por favor, selecciona tu idioma",continue:"Continuar",autodetected:"Hemos detectado tu idioma",moreLanguages:"More languages...",modalTitle:"Seleccionar idioma",searchPlaceholder:"Buscar idioma..."},zh:{title:"æ¬¢è¿Žä½¿ç”¨ OxiCloud",subtitle:"è¯·é€‰æ‹©æ‚¨çš„è¯­è¨€",continue:"ç»§ç»­",autodetected:"æˆ‘ä»¬æ£€æµ‹åˆ°äº†æ‚¨çš„è¯­è¨€",moreLanguages:"æ›´å¤šè¯­è¨€...",modalTitle:"é€‰æ‹©è¯­è¨€",searchPlaceholder:"æœç´¢è¯­è¨€..."},fa:{title:"Ø¨Ù‡ OxiCloud Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯",subtitle:"Ù„Ø·ÙØ§ Ø²Ø¨Ø§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯",continue:"Ø§Ø¯Ø§Ù…Ù‡",autodetected:"Ø²Ø¨Ø§Ù† Ø´Ù…Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯",moreLanguages:"Ø²Ø¨Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±...",modalTitle:"Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ø¨Ø§Ù†",searchPlaceholder:"Ø¬Ø³ØªØ¬ÙˆÛŒ Ø²Ø¨Ø§Ù†..."}},S=[{code:"en",name:"English",nativeName:"English",flag:"ðŸ‡¬ðŸ‡§",popular:!0},{code:"es",name:"Spanish",nativeName:"EspaÃ±ol",flag:"ðŸ‡ªðŸ‡¸",popular:!0},{code:"zh",name:"Chinese",nativeName:"ä¸­æ–‡",flag:"ðŸ‡¨ðŸ‡³",popular:!0},{code:"fa",name:"Persian",nativeName:"ÙØ§Ø±Ø³ÛŒ",flag:"ðŸ‡®ðŸ‡·",popular:!0},{code:"fr",name:"French",nativeName:"FranÃ§ais",flag:"ðŸ‡«ðŸ‡·",popular:!0},{code:"de",name:"German",nativeName:"Deutsch",flag:"ðŸ‡©ðŸ‡ª",popular:!0},{code:"pt",name:"Portuguese",nativeName:"PortuguÃªs",flag:"ðŸ‡§ðŸ‡·",popular:!0},{code:"it",name:"Italian",nativeName:"Italiano",flag:"ðŸ‡®ðŸ‡¹",popular:!0},{code:"ru",name:"Russian",nativeName:"Ð ÑƒÑÑÐºÐ¸Ð¹",flag:"ðŸ‡·ðŸ‡º",popular:!1},{code:"ja",name:"Japanese",nativeName:"æ—¥æœ¬èªž",flag:"ðŸ‡¯ðŸ‡µ",popular:!1},{code:"ko",name:"Korean",nativeName:"í•œêµ­ì–´",flag:"ðŸ‡°ðŸ‡·",popular:!1},{code:"ar",name:"Arabic",nativeName:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",flag:"ðŸ‡¸ðŸ‡¦",popular:!1},{code:"hi",name:"Hindi",nativeName:"à¤¹à¤¿à¤¨à¥à¤¦à¥€",flag:"ðŸ‡®ðŸ‡³",popular:!1},{code:"tr",name:"Turkish",nativeName:"TÃ¼rkÃ§e",flag:"ðŸ‡¹ðŸ‡·",popular:!1},{code:"nl",name:"Dutch",nativeName:"Nederlands",flag:"ðŸ‡³ðŸ‡±",popular:!1},{code:"pl",name:"Polish",nativeName:"Polski",flag:"ðŸ‡µðŸ‡±",popular:!1},{code:"sv",name:"Swedish",nativeName:"Svenska",flag:"ðŸ‡¸ðŸ‡ª",popular:!1},{code:"da",name:"Danish",nativeName:"Dansk",flag:"ðŸ‡©ðŸ‡°",popular:!1},{code:"fi",name:"Finnish",nativeName:"Suomi",flag:"ðŸ‡«ðŸ‡®",popular:!1},{code:"no",name:"Norwegian",nativeName:"Norsk",flag:"ðŸ‡³ðŸ‡´",popular:!1},{code:"uk",name:"Ukrainian",nativeName:"Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°",flag:"ðŸ‡ºðŸ‡¦",popular:!1},{code:"cs",name:"Czech",nativeName:"ÄŒeÅ¡tina",flag:"ðŸ‡¨ðŸ‡¿",popular:!1},{code:"el",name:"Greek",nativeName:"Î•Î»Î»Î·Î½Î¹ÎºÎ¬",flag:"ðŸ‡¬ðŸ‡·",popular:!1},{code:"he",name:"Hebrew",nativeName:"×¢×‘×¨×™×ª",flag:"ðŸ‡®ðŸ‡±",popular:!1},{code:"th",name:"Thai",nativeName:"à¹„à¸—à¸¢",flag:"ðŸ‡¹ðŸ‡­",popular:!1},{code:"vi",name:"Vietnamese",nativeName:"Tiáº¿ng Viá»‡t",flag:"ðŸ‡»ðŸ‡³",popular:!1},{code:"id",name:"Indonesian",nativeName:"Bahasa Indonesia",flag:"ðŸ‡®ðŸ‡©",popular:!1},{code:"ms",name:"Malay",nativeName:"Bahasa Melayu",flag:"ðŸ‡²ðŸ‡¾",popular:!1},{code:"ro",name:"Romanian",nativeName:"RomÃ¢nÄƒ",flag:"ðŸ‡·ðŸ‡´",popular:!1},{code:"hu",name:"Hungarian",nativeName:"Magyar",flag:"ðŸ‡­ðŸ‡º",popular:!1},{code:"ca",name:"Catalan",nativeName:"CatalÃ ",flag:"ðŸ´",popular:!1},{code:"eu",name:"Basque",nativeName:"Euskara",flag:"ðŸ´",popular:!1},{code:"gl",name:"Galician",nativeName:"Galego",flag:"ðŸ´",popular:!1}];function _(){return!localStorage.getItem(I);}async function N(){try{let e=await fetch("/api/auth/status");if(!e.ok)return console.warn("Could not check system status, assuming initialized"),{initialized:!0,admin_count:1,registration_allowed:!0};return await e.json();}catch(e){return console.error("Error checking system status:",e),{initialized:!0,admin_count:1,registration_allowed:!0};}}function B(){for(let e of navigator.languages||[navigator.language||navigator.userLanguage||"en"]){let t=e.substring(0,2).toLowerCase(),o=S.find(e=>e.code===t);if(o)return o;}return S[0];}function b(e,t=""){return window.oxiIcon?window.oxiIcon(e,t):"";}function x(e,t){let o=document.createElement("div");return o.className="lang-picker-item"+(t?" selected":""),o.setAttribute("data-lang",e.code),o.setAttribute("role","option"),o.setAttribute("aria-selected",t),o.innerHTML=`
        <span class="lang-picker-item-flag">${e.flag}</span>
        <span class="lang-picker-item-name">${e.nativeName}</span>
        <span class="lang-picker-item-english">${e.name}</span>
        ${t?b("check","lang-picker-item-check"):""}
    `,o;}function C(){let e=document.getElementById("language-panel"),t=document.getElementById("language-continue"),o=document.getElementById("lang-picker"),n=document.getElementById("lang-picker-selected");document.getElementById("lang-picker-dropdown");let a=document.getElementById("lang-picker-list"),r=document.getElementById("lang-picker-flag"),l=document.getElementById("lang-picker-name"),i=document.getElementById("lang-picker-search-input");if(!e||!o)return;let s=B(),c=s.code;function d(e=""){a.innerHTML="";let t=e.toLowerCase(),o=S.filter(o=>!e||o.name.toLowerCase().includes(t)||o.nativeName.toLowerCase().includes(t)||o.code.toLowerCase().includes(t));if(0===o.length){a.innerHTML='<div class="lang-picker-empty">â€”</div>';return;}o.forEach(e=>{let t=x(e,e.code===c);t.addEventListener("click",t=>{t.stopPropagation(),c=e.code,r.textContent=e.flag,l.textContent=e.nativeName,L(e.code),m(),d("");}),a.appendChild(t);});}function g(){o.classList.add("open"),n.setAttribute("aria-expanded","true"),d(""),i&&(i.value="",setTimeout(()=>i.focus(),50)),setTimeout(()=>{let e=a.querySelector(".lang-picker-item.selected");e&&e.scrollIntoView({block:"nearest"});},60);}function m(){o.classList.remove("open"),n.setAttribute("aria-expanded","false"),i&&(i.value="");}r.textContent=s.flag,l.textContent=s.nativeName,L(c),n.addEventListener("click",e=>{e.stopPropagation(),o.classList.contains("open")?m():g();}),n.addEventListener("keydown",e=>{"Enter"===e.key||" "===e.key?(e.preventDefault(),o.classList.contains("open")?m():g()):"Escape"===e.key&&m();}),i&&(i.addEventListener("input",()=>d(i.value)),i.addEventListener("click",e=>e.stopPropagation())),document.addEventListener("click",e=>{o.contains(e.target)||m();}),t.addEventListener("click",async()=>{if(!c)return;localStorage.setItem(I,c),localStorage.setItem("oxicloud_first_run_completed","true"),window.i18n&&window.i18n.setLocale&&await window.i18n.setLocale(c),e.style.display="none";let t=await N();if(console.log("System status after language selection:",t),t.initialized)document.getElementById("login-panel").style.display="block",await D();else{console.log("No admin exists, showing admin setup panel"),document.getElementById("login-panel").style.display="none",document.getElementById("register-panel").style.display="none",document.getElementById("admin-setup-panel").style.display="block";let e=document.getElementById("back-to-login");e&&(e.parentElement.style.display="none");}});}function L(e){let t=E[e]||E.en,o=document.getElementById("language-title"),n=document.getElementById("language-subtitle"),a=document.getElementById("language-continue"),r=document.getElementById("lang-picker-search-input");o&&(o.textContent=t.title),n&&(n.textContent=t.subtitle),a&&(a.textContent=t.continue),r&&(r.placeholder=t.searchPlaceholder);}async function T(){let e=document.getElementById("language-panel"),t=document.getElementById("login-panel"),o=document.getElementById("admin-setup-panel"),n=document.getElementById("register-panel");if(!e||!t)return;if(_()){console.log("First run - showing language selector"),e.style.display="block",t.style.display="none",n.style.display="none",o.style.display="none";return;}let a=await N();if(console.log("System status:",a),!a.initialized){console.log("Fresh install detected - showing admin setup"),e.style.display="none",t.style.display="none",n.style.display="none",o.style.display="block";let a=document.getElementById("back-to-login");a&&(a.parentElement.style.display="none");return;}e.style.display="none",t.style.display="block",n.style.display="none",o.style.display="none";let r=document.getElementById("show-admin-setup");r&&a.admin_count>0&&(r.parentElement.style.display="none"),await D();}async function D(){try{let e=await fetch("/api/auth/oidc/providers");if(!e.ok)return;let t=await e.json();if(!t.enabled)return;let o=document.getElementById("oidc-login-section"),n=document.getElementById("oidc-login-btn"),a=document.getElementById("login-form"),r=document.getElementById("auth-divider"),l=document.getElementById("show-register");if(!o||!n)return;let i=n.querySelector("span");i&&t.provider_name&&(i.textContent=(window.i18n&&window.i18n.t?window.i18n.t("auth.sso_login_provider"):"Sign in with {{provider}}").replace("{{provider}}",t.provider_name)),n.addEventListener("click",()=>{window.location.href=t.authorize_endpoint;}),t.password_login_enabled||(a&&(a.style.display="none"),r&&(r.style.display="none"),l&&(l.parentElement.style.display="none")),o.style.display="block";}catch(e){console.error("Failed to fetch OIDC provider info:",e);}}function O(){return document.getElementById("login-form")?(n=document.getElementById("language-panel"),e=document.getElementById("login-panel"),t=document.getElementById("register-panel"),o=document.getElementById("admin-setup-panel"),a=document.getElementById("login-form"),r=document.getElementById("register-form"),l=document.getElementById("admin-setup-form"),i=document.getElementById("login-error"),s=document.getElementById("register-error"),c=document.getElementById("register-success"),d=document.getElementById("admin-setup-error"),C(),document.getElementById("show-register").addEventListener("click",()=>{e.style.display="none",t.style.display="block",o.style.display="none";}),document.getElementById("show-login").addEventListener("click",()=>{e.style.display="block",t.style.display="none",o.style.display="none";}),document.getElementById("show-admin-setup").addEventListener("click",()=>{e.style.display="none",t.style.display="none",o.style.display="block";}),document.getElementById("back-to-login").addEventListener("click",()=>{e.style.display="block",t.style.display="none",o.style.display="none";}),!0):(console.log("Not on login page, skipping element initialization"),!1);}let P=O(),$=!1;async function A(e,t){try{console.log(`Attempting to login with username: ${e}`);let o=new AbortController,n=setTimeout(()=>o.abort(),1e4),a=await fetch(m,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t}),signal:o.signal});if(clearTimeout(n),console.log(`Login response status: ${a.status}`),!a.ok)try{let e=await a.json();throw Error(e.error||"Authentication failed");}catch(e){throw Error(`Authentication error (${a.status}): ${a.statusText}`);}try{let e=await a.json();return console.log("Login successful, received data"),e;}catch(e){throw console.error("Error parsing login response:",e),Error("Error processing server response");}}catch(e){throw console.error("Login error:",e),e;}}async function j(e,t,o,n="user"){try{console.log(`Attempting to register user: ${e}`);let a=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,email:t,password:o,role:n})});if(console.log(`Registration response status: ${a.status}`),!a.ok)try{let e=await a.json();throw Error(e.error||"Registration error");}catch(e){throw Error(`Registration error (${a.status}): ${a.statusText}`);}try{let e=await a.json();return console.log("Registration successful, received data"),e;}catch(e){throw console.error("Error parsing registration response:",e),Error("Error processing server response");}}catch(e){throw console.error("Registration error:",e),e;}}async function R(e){try{let t=await fetch(p,{method:"GET",headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw Error("Error fetching user data");return await t.json();}catch(e){throw console.error("Error fetching user data:",e),e;}}async function z(e){try{let t=parseInt(localStorage.getItem("refresh_attempts")||"0");if(localStorage.setItem("refresh_attempts",(t+1).toString()),t>3)throw console.error("Refresh token loop detected, clearing all auth data"),localStorage.removeItem(f),localStorage.removeItem(h),localStorage.removeItem(w),localStorage.removeItem(v),localStorage.removeItem("refresh_attempts"),sessionStorage.removeItem("redirect_count"),Error("Too many refresh attempts, forcing login");if(!e)throw Error("No refresh token available");console.log("Attempting to refresh token");let o=new AbortController,n=setTimeout(()=>o.abort(),5e3),a=await fetch(y,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e}),signal:o.signal});if(clearTimeout(n),!a.ok)throw console.warn(`Refresh token failed with status: ${a.status}`),Error(`Token refresh failed: ${a.status}`);let r=await a.json();console.log("Refresh token response:",r);let l=new Date;return l.setDate(l.getDate()+30),localStorage.setItem(f,r.access_token||r.token),localStorage.setItem(h,r.refresh_token||r.refreshToken||e),localStorage.setItem(w,l.toISOString()),r.user&&localStorage.setItem(v,JSON.stringify(r.user)),localStorage.setItem("refresh_attempts","0"),sessionStorage.removeItem("redirect_count"),r;}catch(e){throw console.error("Token refresh error:",e),localStorage.removeItem(f),localStorage.removeItem(h),localStorage.removeItem(w),localStorage.removeItem(v),localStorage.removeItem("refresh_attempts"),sessionStorage.removeItem("redirect_count"),e;}}async function J(){try{return console.log("Checking if this is first run"),!1;}catch(e){return console.error("Error checking first run:",e),!1;}}function M(){console.log("Redirecting to main application");try{if(localStorage.setItem("refresh_attempts","0"),sessionStorage.removeItem("redirect_count"),!localStorage.getItem(w)){let e=new Date;e.setDate(e.getDate()+30),localStorage.setItem(w,e.toISOString());}if(!localStorage.getItem(f))return void console.error("No token found, cannot redirect to app");window.location.replace("/");}catch(e){console.error("Error during redirect:",e),window.location.href="/login?error=redirect_failed";}}function H(){localStorage.removeItem(f),localStorage.removeItem(h),localStorage.removeItem(w),localStorage.removeItem(v),window.location.href="/login";}(()=>{let e=parseInt(localStorage.getItem("refresh_attempts")||"0"),t=new URLSearchParams(window.location.search).get("source");e>3&&(console.error("EMERGENCY: Detected severe token refresh loop. Cleaning all auth data."),localStorage.clear(),sessionStorage.clear(),localStorage.setItem("emergency_clean","true"),localStorage.setItem("last_emergency_clean",Date.now().toString())),"app"===t&&(console.log("Detected redirect from app, ensuring clean auth state"),localStorage.removeItem("oxicloud_token"),localStorage.removeItem("oxicloud_refresh_token"),localStorage.removeItem("oxicloud_token_expiry"),sessionStorage.removeItem("redirect_count"),localStorage.setItem("refresh_attempts","0"));let o=parseInt(localStorage.getItem("last_emergency_clean")||"0"),n=Date.now()-o;o>0&&n<1e4&&(console.warn("Multiple auth problems in short time, clearing auth data"),localStorage.removeItem("oxicloud_token"),localStorage.removeItem("oxicloud_refresh_token"),localStorage.removeItem("oxicloud_token_expiry"));})(),document.addEventListener("DOMContentLoaded",()=>{if("hidden"===document.visibilityState)return void console.warn("Page hidden, avoiding potential navigation loop");if(!document.getElementById("login-form"))return void console.log("Not on login page, skipping auth check");let n=new URLSearchParams(window.location.search).get("oidc_code");if(n){console.log("OIDC exchange code detected on login page, exchanging..."),(async()=>{try{let e=await fetch("/api/auth/oidc/exchange",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:n})});if(!e.ok)return void console.error("OIDC exchange failed:",e.status);let t=await e.json(),o=t.access_token||t.token,a=t.refresh_token||t.refreshToken;if(o){localStorage.setItem(f,o),a&&localStorage.setItem(h,a);let e=o.split(".");if(3===e.length)try{let t=JSON.parse(atob(e[1]));if(t.exp){let e=new Date(1e3*t.exp);isNaN(e.getTime())||localStorage.setItem(w,e.toISOString());}}catch(e){}t.user&&localStorage.setItem(v,JSON.stringify(t.user)),window.location.href="/";return;}}catch(e){console.error("OIDC exchange error:",e);}})();return;}$?console.log("Auth already initialized, skipping"):($=!0,T().then(()=>{console.log("Initial panel shown based on system status");}).catch(e=>{console.error("Error showing initial panel:",e);}),console.log("Login page loaded, clearing all counters"),sessionStorage.removeItem("redirect_count"),localStorage.removeItem("refresh_attempts"),(async()=>{try{let n=localStorage.getItem(f),a=localStorage.getItem(w);if(!n){console.log("No token found, user needs to login"),localStorage.removeItem(h),localStorage.removeItem(w),localStorage.removeItem(v);return;}try{let e=new Date(a);if(!isNaN(e.getTime())&&e>new Date){console.log(`Token valid until ${e.toLocaleString()}`),M();return;}console.log("Token expired or invalid date, attempting refresh");}catch(e){console.error("Error parsing token expiry date:",e);}let r=localStorage.getItem(h);if(r)try{console.log("Attempting to refresh expired token"),await z(r),console.log("Token refresh successful, redirecting to app"),M();}catch(e){console.log("Token refresh failed, user needs to login again:",e.message),localStorage.removeItem(f),localStorage.removeItem(h),localStorage.removeItem(w),localStorage.removeItem(v);}else console.log("No refresh token found, user needs to login");await J()&&(e.style.display="none",t.style.display="none",o.style.display="block");}catch(e){console.error("Authentication check failed:",e);}})());}),P&&a&&a.addEventListener("submit",async e=>{e.preventDefault(),i.style.display="none";let t=document.getElementById("login-username").value,o=document.getElementById("login-password").value;try{let e=await A(t,o);console.log("Login response:",e);let n=e.access_token||e.token,a=e.refresh_token||e.refreshToken;if(!n)throw Error("Server did not return an access token");localStorage.setItem(f,n),localStorage.setItem(h,a);let r=!1,l=n.split(".");if(3===l.length)try{let e=JSON.parse(atob(l[1]));if(e.exp){let t=new Date(1e3*e.exp);isNaN(t.getTime())?console.warn("Invalid expiry date in token:",e.exp):(localStorage.setItem(w,t.toISOString()),r=!0,console.log(`Token expires on: ${t.toLocaleString()}`));}}catch(e){console.error("Error parsing JWT token:",e);}if(!r){console.log("Setting default token expiry (30 days)");let e=new Date;e.setDate(e.getDate()+30),localStorage.setItem(w,e.toISOString());}sessionStorage.removeItem("redirect_count"),e.user?(console.log("Storing user data from server"),localStorage.setItem(v,JSON.stringify(e.user))):console.warn("Server did not return user data â€” will fetch from /me endpoint after redirect"),M();}catch(e){i.textContent=e.message||"Error logging in",i.style.display="block";}}),P&&r&&r.addEventListener("submit",async o=>{o.preventDefault(),s.style.display="none",c.style.display="none";let n=document.getElementById("register-username").value,a=document.getElementById("register-email").value,l=document.getElementById("register-password").value;if(l!==document.getElementById("register-password-confirm").value){let e=window.i18n?window.i18n.t("auth.passwords_mismatch"):"Passwords do not match";s.textContent=e,s.style.display="block";return;}try{await j(n,a,l);let o=window.i18n?window.i18n.t("auth.account_success"):"Account created successfully! You can now log in.";c.textContent=o,c.style.display="block",r.reset(),setTimeout(()=>{e.style.display="block",t.style.display="none";},2e3);}catch(t){let e=window.i18n?window.i18n.t("auth.admin_create_error"):"Error registering account";s.textContent=t.message||e,s.style.display="block";}}),P&&l&&l.addEventListener("submit",async t=>{t.preventDefault(),d.style.display="none";let n=document.getElementById("admin-setup-success");n&&(n.style.display="none");let a=document.getElementById("admin-email").value,r=document.getElementById("admin-password").value;if(r!==document.getElementById("admin-password-confirm").value){let e=window.i18n?window.i18n.t("auth.passwords_mismatch"):"Passwords do not match";d.textContent=e,d.style.display="block";return;}try{await j("admin",a,r,"admin");let t=window.i18n?window.i18n.t("auth.admin_success"):"Admin account created successfully! You can now log in.";n&&(n.textContent=t,n.style.display="block"),setTimeout(()=>{e.style.display="block",o.style.display="none",n&&(n.style.display="none");},2e3);}catch(t){let e=window.i18n?window.i18n.t("auth.admin_create_error"):"Error creating admin account";d.textContent=t.message||e,d.style.display="block";}});