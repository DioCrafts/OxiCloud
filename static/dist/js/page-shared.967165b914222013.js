function e(){let e=localStorage.getItem("oxicloud_token"),t=localStorage.getItem("oxicloud_token_expiry");(!e||!t||new Date(t)<new Date)&&(window.location.href="/login");}document.addEventListener("DOMContentLoaded",async()=>{function t(e,t){return window.i18n&&window.i18n.t?window.i18n.t(e,t):t;}function n(e=!1){let t={},i=localStorage.getItem("oxicloud_token");return i&&(t.Authorization=`Bearer ${i}`),e&&(t["Content-Type"]="application/json"),t;}let i=document.getElementById("shared-items-list"),a=document.getElementById("empty-shared-state"),r=document.getElementById("filter-type"),o=document.getElementById("sort-by"),d=document.getElementById("shared-search"),s=document.getElementById("shared-search-btn"),c=document.getElementById("go-to-files"),l=document.getElementById("share-dialog"),m=l?l.querySelector(".close-dialog-btn"):null,u=document.getElementById("share-dialog-icon"),h=document.getElementById("share-dialog-name"),p=document.getElementById("share-link-url"),y=document.getElementById("copy-link-btn"),E=document.getElementById("enable-password"),g=document.getElementById("share-password"),f=document.getElementById("generate-password"),v=document.getElementById("enable-expiration"),w=document.getElementById("share-expiration"),_=document.getElementById("permission-read"),k=document.getElementById("permission-write"),L=document.getElementById("permission-reshare"),I=document.getElementById("update-share-btn"),x=document.getElementById("remove-share-btn"),b=document.getElementById("share-notification-dialog"),B=b?b.querySelector(".close-dialog-btn"):null,S=document.getElementById("notify-dialog-icon"),C=document.getElementById("notify-dialog-name"),T=document.getElementById("notification-email"),N=document.getElementById("notification-message"),F=document.getElementById("send-notification-btn"),D=document.getElementById("notification-banner"),M=document.getElementById("notification-message"),R=document.getElementById("close-notification"),$=null,H=[],U=[];if(e(),await j(),r&&r.addEventListener("change",q),o&&o.addEventListener("change",q),s&&s.addEventListener("click",q),d){let e;d.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(q,250);}),d.addEventListener("keyup",t=>{"Enter"===t.key&&(clearTimeout(e),q());});}async function j(){try{let e=await fetch("/api/shares?page=1&per_page=1000",{headers:n()});H=e.ok&&(await e.json()).items||[];}catch(e){console.error("Error loading shared items:",e),H=[];}q();}function q(){let e=r?r.value:"all",n=o?o.value:"date",s=d?d.value.toLowerCase():"";(U=H.filter(t=>("all"===e||t.item_type===e)&&(t.item_name||t.item_id||"").toLowerCase().includes(s))).sort((e,t)=>"name"===n?(e.item_name||e.item_id||"").localeCompare(t.item_name||t.item_id||""):"date"===n?(t.created_at||0)-(e.created_at||0):"expiration"===n?e.expires_at||t.expires_at?e.expires_at?t.expires_at?e.expires_at-t.expires_at:-1:1:0:0),function(){if(!i)return;if(i.innerHTML="",0===U.length){a&&(a.style.display="flex");let e=document.querySelector(".shared-list-container");e&&(e.style.display="none");return;}a&&(a.style.display="none");let e=document.querySelector(".shared-list-container");e&&(e.style.display="block"),U.forEach(e=>{let n=document.createElement("tr"),a=e.item_name||e.item_id||"Unknown",r=document.createElement("td");r.className="shared-item-name",r.innerHTML=`<span class="item-icon">${"file"===e.item_type?"ğŸ“„":"ğŸ“"}</span><span>${a}</span>`;let o=document.createElement("td");o.textContent="file"===e.item_type?t("shared_typeFile","File"):t("shared_typeFolder","Folder");let d=document.createElement("td");d.textContent=J(e.created_at);let s=document.createElement("td");s.textContent=e.expires_at?J(e.expires_at):t("shared_noExpiration","No expiration");let c=document.createElement("td"),m=[];e.permissions?.read&&m.push(t("share_permissionRead","Read")),e.permissions?.write&&m.push(t("share_permissionWrite","Write")),e.permissions?.reshare&&m.push(t("share_permissionReshare","Reshare")),c.textContent=m.join(", ")||"Read";let y=document.createElement("td");y.textContent=e.has_password?t("shared_hasPassword","Yes"):t("shared_noPassword","No");let f=document.createElement("td");f.className="shared-item-actions";let I=document.createElement("button");I.className="action-btn edit-btn",I.innerHTML='<span class="action-icon">âœï¸</span>',I.title=t("shared_editShare","Edit Share"),I.addEventListener("click",()=>{var t;let n;return $=t=e,n=t.item_name||t.item_id||"Unknown",void(u&&(u.textContent="file"===t.item_type?"ğŸ“„":"ğŸ“"),h&&(h.textContent=n),p&&(p.value=t.url||""),_&&(_.checked=t.permissions?.read!==!1),k&&(k.checked=!!t.permissions?.write),L&&(L.checked=!!t.permissions?.reshare),E&&(E.checked=t.has_password,g&&(g.disabled=!E.checked,g.value="")),v&&(v.checked=!!t.expires_at,w&&(w.disabled=!v.checked,w.value=t.expires_at?new Date(1e3*t.expires_at).toISOString().split("T")[0]:"")),l&&l.classList.add("active"));});let x=document.createElement("button");x.className="action-btn notify-btn",x.innerHTML='<span class="action-icon">ğŸ“§</span>',x.title=t("shared_notifyShare","Notify Someone"),x.addEventListener("click",()=>{var t;let n;return $=t=e,n=t.item_name||t.item_id||"Unknown",void(S&&(S.textContent="file"===t.item_type?"ğŸ“„":"ğŸ“"),C&&(C.textContent=n),T&&(T.value=""),N&&(N.value=""),b&&b.classList.add("active"));});let B=document.createElement("button");B.className="action-btn copy-btn",B.innerHTML='<span class="action-icon">ğŸ“‹</span>',B.title=t("shared_copyLink","Copy Link"),B.addEventListener("click",()=>{navigator.clipboard.writeText(e.url).then(()=>z(t("shared_linkCopied","Link copied!"))).catch(()=>z(t("shared_linkCopyFailed","Failed to copy link"),"error"));});let F=document.createElement("button");F.className="action-btn remove-btn",F.innerHTML='<span class="action-icon">ğŸ—‘ï¸</span>',F.title=t("shared_removeShare","Remove Share"),F.addEventListener("click",()=>{$=e,W();}),f.append(I,x,B,F),n.append(r,o,d,s,c,y,f),i.appendChild(n);});}();}function P(){l&&l.classList.remove("active"),$=null;}function O(){b&&b.classList.remove("active"),$=null;}async function A(){if(!$)return;let e={permissions:{read:!_||_.checked,write:!!k&&k.checked,reshare:!!L&&L.checked},password:E&&E.checked&&g&&g.value?g.value:null,expires_at:v&&v.checked&&w&&w.value?Math.floor(new Date(w.value).getTime()/1e3):null};try{let i=await fetch(`/api/shares/${$.id}`,{method:"PUT",headers:n(!0),body:JSON.stringify(e)});if(!i.ok){let e=await i.json().catch(()=>({}));throw Error(e.error||`Server error ${i.status}`);}z(t("shared_itemUpdated","Share settings updated"));}catch(e){console.error("Error updating share:",e),z(e.message||"Error updating share","error");}P(),await j();}async function W(){if($){try{let e=await fetch(`/api/shares/${$.id}`,{method:"DELETE",headers:n()});if(!e.ok&&204!==e.status)throw Error(`Server error ${e.status}`);z(t("shared_itemRemoved","Share removed"));}catch(e){console.error("Error removing share:",e),z("Error removing share","error");}P(),await j();}}function z(e,t="success"){M&&D?(M.textContent=e,D.className="notification-banner active "+t,setTimeout(()=>D.classList.remove("active"),5e3)):window.ui&&window.ui.showNotification?window.ui.showNotification(e,t):alert(e);}function J(e){return window.formatDateShort?window.formatDateShort(e):String(e);}c&&c.addEventListener("click",()=>window.location.href="/"),m&&m.addEventListener("click",P),y&&y.addEventListener("click",function(){p&&navigator.clipboard.writeText(p.value).then(()=>z(t("shared_linkCopied","Link copied!"))).catch(()=>z(t("shared_linkCopyFailed","Failed to copy link"),"error"));}),E&&E.addEventListener("change",()=>{g&&(g.disabled=!E.checked,E.checked&&g.focus());}),f&&f.addEventListener("click",function(){if(!g||!E)return;let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*",t=new Uint32Array(16);crypto.getRandomValues(t);let n="";for(let i=0;i<16;i++)n+=e[t[i]%e.length];g.value=n,E.checked=!0,g.disabled=!1;}),v&&v.addEventListener("change",()=>{w&&(w.disabled=!v.checked,v.checked&&w.focus());}),I&&I.addEventListener("click",A),x&&x.addEventListener("click",W),B&&B.addEventListener("click",O),F&&F.addEventListener("click",function(){if(!$)return;let e=T?T.value.trim():"",n=N?N.value.trim():"";e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?window.fileSharing&&window.fileSharing.sendShareNotification&&window.fileSharing.sendShareNotification($.url,e,n).then(()=>{O(),z(t("shared_notificationSent","Notification sent"));}).catch(()=>z(t("shared_notificationFailed","Failed to send notification"),"error")):z(t("shared_invalidEmail","Please enter a valid email address"),"error");}),R&&R.addEventListener("click",()=>{D&&D.classList.remove("active");});});